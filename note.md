### 一 概述

#### 1 通信技术和计算机网络的发展

1946年，第一台通用电子计算机ENIAC。

ARPANET最早把主机间通信作为研究目标。

计算机网络的发展：

- 第一代：面向终端的计算机网络，以单个计算机为主的远程通信系统，包括一台中心计算机和多台终端，如SAGE、SABRE。
- 第二代：以网络为中心的计算机网络，多台具有==自主处理功能==的计算机通过通信线路互连，系统由主机Host（运行用户程序）和接口信息处理机IMP（处理主机间通信请求）组成，如ARPANET。

> ARPANET
>
> 主机：运行网络应用程序。
>
> IMP：即交换机或路由器。
>
> 所有的主机构成了**资源子网**。
>
> 所有的IMP和通信链路构成了**通信子网**。

- 第三代：统一标准的互联计算机网络，具有统一的网络体系结构，遵循国际标准化的协议。OSI/RM七层模型；TCP/IP体系结构（Internet，事实上的国际标准）。

#### 2 计算机通信网的概念

计算机通信网的三个要素：

1. 至少两台自治的计算机互相连接起来。
2. 需要通信通道。
3. 通信协议。

#### 3 计算机通信网的组成

计算机**通信**的要素（通信子网）：

- 计算机的通信子系统：面向应用进程--将不同类型的数据转换成双方认可的形式；面向网络--确定数据通路、数据的差错控制、网络路由选择、流量控制、网络互连等。
- 数据通信系统：为计算机间的信息交互提供传输媒介，提供可靠的数据传送能力。

<img src="/Users/wangzifan/Desktop/通信网络/pic/计算机通信的要素.png" alt="计算机通信的要素" style="zoom:50%;" />

计算机**通信网**的组成：

- 通信子网：负责数据的无差错和有序传递，差错控制、流量控制、路由选择、网络互连等。
- 资源子网：是计算机通信的本地系统环境，包括主机、终端和应用程序等，负责用户资源配置、数据的处理和管理、软/硬件共享及负载均衡等。

**计算机通信网**就是一个**由通信子网承载**的、传输和共享**资源子网的各类信息**的系统。

#### 4 计算机网络的分类

- 按传输技术：广播式网络/点到点网络

- 按规模：个域网/局域网/城域网/广域网/互联网

- 按传输介质：有线网/无线网
- 按拓扑结构：总线/环形/网状/星形
- 按使用范围：专用网/公共网

##### 网络拓扑结构：

通信子网中交换节点的互连模式，有**集中式**和**分布式**两种基本类型。

<img src="/Users/wangzifan/Desktop/通信网络/pic/分布式子网的拓扑结构.png" alt="分布式子网的拓扑结构" style="zoom:50%;" />

广域网中常见**树型**和**不规则型**，局域网中常见**规则型**（星、环、总线）。

##### 网络传输技术：

点到点网络--每一对源/宿端之间有一条传输通路。

广播网络：网络上所有节点共享一条信道。

##### 网络规模

个域网PAN：计算机与外围设备的连接。

局域网LAN：单位内部使用的高速宽带网络，主要用于共享资源。

城域网MAN：覆盖一个城市，连接多个局域网，用作城市内数据传输和交换（骨干网）。

广域网：覆盖一个国家或更广的范围，数据传输速率低，延时大，采用分组交换和路由技术确保数据正确传送。

互联网（internet）：将多个不同的计算机网络通过一个**统一的标准**互相连接起来，常见的互联网是通过WAN连接起来的LAN的集合，中间通过**网关**兼容不同网络。

#### 5 网络软件及协议体系结构

##### 网络软件的分类

与计算机通信网有关的软件大致分5类：

- 操作系统核心软件：多任务、处理来自不同计算机的数据收发。
- 通信控制用协议软件：计算机通信网中各个部分必须遵守的规则的集合。
- 管理软件：安全、故障处理、系统配置。
- 交换与路由软件：在通信主体之间建立和维护信道。
- 应用软件：为用户提供网络服务。

##### 通信协议的定义

相互通信的双方（多方）对如何进行信息交换所必须遵守的一整套规则。

建立连接要遵守的规则：

1. 在源-宿点之间存在**物理的传输资源**。
2. **多路接入**技术必须与所使用的设备配合，执行协议。
3. **差错处理**的实现需要由两个端设备之间运行的协议来处理（ARQ）。
4. 需要**寻址**和**路由**来保证信息到达正确目的地。
5. 端节点/交换节点存储收到的信息，等待这些信息得到使用或转发出去，需要协议来协调设备间的动作。
6. **流量控制**，防止缓冲器溢出，防止拥挤。
7. 保证通路与用户特性一致，如消息格式、字符编码等。

##### 协议的分类

- 面向应用的协议：为完成特定应用而制定，如TCP/IP、FTP、TELNET、SMTP。
- 系统到系统的协议：支持系统中特定应用进程间的数据交换、为应用进程提供网络通信服务，如应用层公用服务元素、表示层协议（数据加解密）。
- 端到端协议：完成端到端的可靠传输，建立、保持、维护端到端连接，如TCP、UDP。
- 其他网内协议：流量控制、寻址和路由。
- 点到点协议：实现直接相连的节点间的数据传输，如数据链路层协议HDLC、PPP。
- 网络接入协议：如介质介入控制协议MAC。
- 网间互联协议：不同网络用户寻址、异构网络间的协议转换，如IP协议。

##### 协议的三要素

- 语法：用户数据与控制信息的结构与格式，数据出现顺序的意义。
- 语义：解释比特流的每一部分的意义。
- 时序：事件实现顺序的说明。

##### 分层的协议体系结构

体系结构是计算机通信网的一种**抽象的**、**层次化的**功能模型，将庞大复杂的协议分层，各层完成不同功能。

每一层本身的功能与下层提供的服务叠加到一起服务上层，从而使最高层为用户提供一组完整的服务。

##### 协议体系结构实例

国际标准化组织ISO在1978年提出网络互连标准--开放系统互连OSI参考模型。

当前使用最广泛的网络体系结构是以TCP/IP协议模型为主的Internet结构。

<img src="/Users/wangzifan/Desktop/通信网络/pic/OSI:RM体系结构.png" alt="OSI:RM体系结构" style="zoom:50%;" />

<img src="/Users/wangzifan/Desktop/通信网络/pic/OSI:RM模型数据流.png" alt="OSI:RM模型数据流" style="zoom:50%;" />

##### OSI参考模型各层功能

- 物理层：比特流的物理传输、故障监测、物理管理；从数据链路层接收帧，将比特流转换成底层物理介质上的信号。
- 数据链路层：在物理链路的两端之间传输数据；向网络层实体提供数据传输功能和控制；提供数据的**流量控制**；**检测和纠正物理链路产生的差错**；格式化的消息称为**帧**。
- 网络层：负责**端到端**的数据的路由和交换；寻址并解决**异构网络间传输数据**的相关问题；格式化的消息称为**分组**。
- 传输层：提供无差错的数据传输；接收来自会话层的数据，按需分割成更小的组传递给网络层；在**系统**间提供**可靠透明**的数据传输，提供端到端的**错误恢复**和**流量控制**。

> 传输层的功能之一是提供可靠有效的网络连接。
>
> 它允许上面的三个层不受实际网络结构约束，各自执行任务。
>
> 它依靠下面的三个层控制实际的网络操作。

- 会话层：提供**节点**之间通信过程的协调；负责执行会话规则（半双工/全双工）、同步数据流、故障重连。
- 表示层：提供数据格式变换、编码转换；执行该层的数据压缩和加密；常合并在应用层中。
- 应用层：包括各种协议，定义具体的面向用户的应用，TELNET、FTP、SMTP、DNS、HTTP。

**低三层属于通信子网**，为用户提供透明连接，操作以链路为基础（hop by hop），在节点间的各条链路上进行通信。

**高三层属于资源子网**，保证信息以正确可理解的形式传送。

**传输层是接口**，是第一个端到端的层次，保证透明的端到端连接，满足用户的服务质量要求（QoS），向高三层提供服务。



#### TCP/IP协议模型

包括：应用层、传输层、网际层、网络接口层。

| TCP/IP模型分层            | 主要功能                                                     |
| ------------------------- | ------------------------------------------------------------ |
| 主机-网络层（网络接口层） | 定义了Internet与各种**物理网络**之间的接口                   |
| 网络互联层（网际层）      | 负责相邻计算机之间（点对点）通信，处理来自传输层的分组发送请求，检查并转发数据报、路由、流量控制 |
| 传输层                    | 提供可靠的点对点数据传输                                     |
| 应用层                    | 提供各种网络服务                                             |

##### 网络互联层协议

- Internet协议（IP）：位于**通信子网**的最高层，提供点对点**无连接**的数据报传输机制，不保证可靠性；IP协议向上层（TCP）提供统一的IP数据报，屏蔽了各种物理帧的差异性；IP数据报由头标和数据两部分组成，头标含有大量控制和特性信息。
- Internet控制信息协议（ICMP）
- 地址解析协议（ARP）
- 反向地址解析协议（RARP）

##### 传输层协议

- 传输控制协议TCP：是传输层中使用最广泛的一种协议；提供**可靠通信**，数据报破坏或丢失时由TCP负责重传；检测纠正传输错误。
- 用户数据报协议UDP：**不可靠、无连接**，用于语音、视频传输。

<img src="/Users/wangzifan/Desktop/通信网络/pic/TCP:IP层次.png" alt="TCP:IP层次" style="zoom:50%;" />

> OSI/RM与TCP/IP模型比较：
>
> 二者都采用了层次结构的概念，在传输层中二者定义了相似的功能。
>
> 但在层次的划分和协议的使用上有很大区别。

> TCP/IP模型的缺点：
>
> - 没有明确划分服务、接口、协议的概念
> - 缺乏通用性，很难适合非TCP/IP协议栈。
> - 主机-网络层并不是真正意义上的层。
> - TCP/IP模型不区分物理层和数据链路层。



---

### 二 协议分层原理

#### 1 OSI/RM概述

网络环境：涉及与不同类型数据通信网有关的协议与标准，包括**通信子系统中面向网络的功能+数据通信网**。

开放系统互连环境：即OSI环境（OSIE），由遵循OSI标准的开放端系统和开放中继系统组成。

实系统环境：建立在OSI环境之上，**通信子网+资源子网**。

<img src="/Users/wangzifan/Desktop/通信网络/pic/计算机的运行环境.png" alt="计算机的运行环境" style="zoom:50%;" />

经中继开放系统的开放系统互连环境示意图

<img src="/Users/wangzifan/Desktop/通信网络/pic/带中继的开放系统互连环境示意图.png" alt="带中继的开放系统互连环境示意图" style="zoom:50%;" />

> 中继开放系统是数据通信网中**交换节点**的层次结构的抽象，只包含低三层或低两层。

#### 2 层的相关概念

（N）层：表示协议的某一层，对等的（N）子系统构成OSI/RM中的（N层）。

（N）协议：一台机器上的（N）层与另一台机器上的（N）层进行通话时采用的规则。

（N）实体：一个（N）子系统内部的活动要素，如一个TCP连接。

接口：每一相邻层间有一个接口，定义下层向上层提供的原语操作和服务--**服务访问点AP**。

虚拟通信：两个开放系统中的对等实体之间的信息交换--**水平方向**。

实信息流：在同一系统中的上下层之间发生--**垂直方向**。

##### 服务与服务访问点

（N）服务：（N）层及其下面各层的综合能力（N实体自己提供的功能+从N-1层获得的服务+与对等实体通信得到的功能），并在（N）层和（N+1）层的分界面上提供给（N+1）实体。

服务访问点Service Access Point：N层的SAP是N+1层可以访问N层服务的地方。

相邻层实体使用SAP的规则：

- 一个（N）SAP只能被一个N实体使用，只能被一个N+1实体使用。
- 一个N实体可以使用多个（N）SAP，一个（N+1）实体可以使用多个（N）SAP。

（N）协议：对等的N实体间交互的规则与格式的集合，规定了N实体如何利用N-1服务并协同工作以完成（N）功能。

<img src="/Users/wangzifan/Desktop/通信网络/pic/协议与服务.png" alt="协议与服务" style="zoom:50%;" />

> 服务与协议的关系
>
> 服务（上下关系）：是各层向上层提供的一组原语（操作）；定义了该层能完成的操作；只与两层之间的接口有关。
>
> 协议（水平关系）：是一组规则；决定同层对等实体交换帧、包、报文的格式和意义；实体用协议来实现它们的服务定义。

##### 服务分类

面向连接服务

- 具有连接建立、数据传输、连接释放三个阶段
- 在数据交换之前，必须先建立连接
- 数据交换结束后，必须终止连接
- 传送数据时，按顺序传送

无连接服务

- 对等实体间的通信不需要先建立好连接
- 不需要通信实体双方同时是活跃的
- 不能防止报文丢失、失序，是不可靠服务

##### 标识符

名称：一个对象的永久性标识符。

名称域：名称空间的一个子集。

在OSI环境中**实体的局部名**是一个实体在**层内**被唯一标识的名称，**实体的全局名**是在**OSI环境内**的唯一名称（包括一个层名称域名和一个局部名）。

**（N）服务访问点的标识符称为（N）地址。**使用（N）地址可以唯一地标识与某个（N+1）实体相连的一个特定（N）SAP。

##### 地址映射

（N）层内的一个（N）实体可以连接多个（N-1）SAP和多个（N）SAP，在（N）层中建立（N）SAP与（N-1）SAP的对应关系称为**（N）地址映射**。

#### 3连接及其操作

（N）连接：对等（N+1）实体之间交换数据时，必须在（N）层内使用（N）协议在（N+1）实体之间建立联系。

（N）连接形式：

- 点对点连接：实体之间仅有一个连接。
- 多端点连接：实体之间可有多个连接（如广播通信）。同一对SAP之间也可以存在多条连接，以连接端点Connection End Point标识区分。

##### 连接的建立与释放

（N）层对等实体建立（N）连接：

- 在提供支持的（N）实体之间有一条（N-1）连接。
- 两边（N）实体处于能交换连接建立协议的状态。

释放（N）连接的三种情况：

- 常规释放：对等（N+1）实体间完成数据传送后，任何一方（N+1）实体均可发起释放（N）连接。
- 有序释放：令牌释放，持有令牌的（N+1）实体才有权发起释放（N）连接。
- 异常释放：发生异常无法进行（N）连接上的数据传输时释放（N）连接。（N+1）实体发生异常，由其发起异常释放，（N）实体发生异常，则由（N）实体释放。

##### 连接的复用与分用

<img src="/Users/wangzifan/Desktop/通信网络/pic/连接的复用与分用.png" alt="连接的复用与分用" style="zoom:50%;" />

- 一对一映射：每条（N）连接建立在一条（N-1）连接上。
- 多对一映射（复用）：若干条（N）连接建立在同一条（N-1）连接上。
- 一对多映射（分用）：一条（N）连接建立在若干条（N-1）连接上。

> 复用的目的：提高使用效率，节省费用；在只有一条（N-1）连接时，提供多条（N）连接。
>
> 分用的目的：在有多条（N-1）连接可用时，提高可靠性；提高吞吐量和服务质量；利用廉价的多条（N-1）连接提高经济效益。

#### 4 数据传送

信息传输的两种情况：

- 水平传输：在已经建立连接的对等（N）实体之间传送（受（N）协议的控制）。
- 垂直传输：在同一开放系统相邻子系统的实体之间传送，即连接到同一个（N-1）SAP的（N）实体与（N-1）实体之间的传送。

##### 协议组成

（N）PCI（Protocol Control Information）：协议控制信息，协调对等实体间的协同工作，一般作为协议头header。

（N）PDU（Protocol Data Unit）：通过网络传给对等实体的信息。PDU=PCI+UD(User Data)。

（N-1）ICI（Interface Control Information）：协调相邻层的（N）实体与（N-1）实体的联合操作。

（N-1）IDU（Interface Data Unit）:（N）层实体通过SAP传递给（N-1）层实体的信息。IDU=ICI+ID。

（N-1）SDU（Service Data Unit）：（N）实体与（N-1）实体之间传送的信息，是**（N-1）接口数据的总和**。

<img src="/Users/wangzifan/Desktop/通信网络/pic/PDU-IDU-SDU关系.png" alt="PDU-IDU-SDU关系" style="zoom:50%;" />

##### 数据单元的分与合

不同层的数据单元，其长度受到该层协议的控制，不同层次的数据长度未必一致。

<img src="/Users/wangzifan/Desktop/通信网络/pic/分段和合段.png" alt="分段和合段" style="zoom:50%;" />

<img src="/Users/wangzifan/Desktop/通信网络/pic/拼接.png" alt="拼接" style="zoom:50%;" />

#### 5 服务原语

服务原语（Service Primitive）：服务用户与服务提供者之间进行交互时所要交换的一些必要信息。

OSI/RM规定了四种服务原语类型

| 原语类型       | 含义                   |
| -------------- | ---------------------- |
| 请求request    | 一个实体希望得到服务   |
| 指示indication | 通知一个实体有事件发生 |
| 相应response   | 一个实体对事件作出响应 |
| 证实confirm    | 返回对先前请求对响应   |

建立（N）连接的原语交互

<img src="/Users/wangzifan/Desktop/通信网络/pic/建立N连接的原语交互.png" alt="建立N连接的原语交互" style="zoom:50%;" />



---

### 三 数字通信基础

#### 1 数据通信系统模型

<img src="/Users/wangzifan/Desktop/通信网络/pic/数据通信系统模型.png" alt="数据通信系统模型" style="zoom:50%;" />

#### 2 数据传输相关概念

- 数据：运送消息的实体——模拟数据/数字数据。
- 信号：数据的电磁或电子编码，使数据能以适当的形式在介质上传输——模拟信号/数字信号。
- 码元：时域波形中代表不同离散数值的**基本波形**。
- 波特率：每秒钟信号变化的次数（每秒采样的次数），也称**码元速率**，单位Hz。
- 比特率：每秒钟传输的数据的位数，即**数据传输速率**，单位bps。

> 信号分为V级，则比特率=log2V*波特率。

##### 信道及其参数

- 传输介质与信道：传输介质是传输信号的**物理载体**，信道提供了传输信号所需的**带宽**，体现介质的**逻辑特性**。
- 信道的工作方式：
  - 单工通信——只能有一个方向的通信
  - 半双工通信——通信双方任意一方发送，另一方接收，不能同时收发。
  - 全双工通信——通信双方可以同时发送和接收信息（**全双工需要两条信道**）。

> Nyquist定理：在假定的理想条件（无噪声）下，为了避免**码间串扰**，码元的传输速率有上限。无噪声信道带宽为W Hz时，码元传输速率上限为2W Baud，相应数据传输速率为2W*logV b/s。
>
> 香农(Shannon)定理：带宽受限且有高斯白噪声干扰的信道的极限、无差错的信息传输速率。当带宽为W Hz，信噪比为S/N，最大数据传输速率为W*log(1+S/N) b/s。

- 基带传输：信号源产生的原始电信号称为**基带信号**，将数字数据0/1直接用两种不同的电压表示，送到线路上传输。
- 宽带传输：将基带信号调制后形成模拟信号，然后采用**频分复用**技术实现宽带传输。

##### 同步通信和异步通信

同步：要求通信双方在**时间基准**上保持一致。通信双方需要保持**位同步**，根据位同步方式可分为**同步通信**和**异步通信**。

- 异步通信：发送方和接收方的采样时钟不是同一个。每个字符附加1个起始位和1个停止位。

- 同步通信：发送方和接收方的采样时钟是同一个（发送方在数据编码中包含时钟，接收方提取时钟用以采样）。
  - 面向字符的同步通信：数据块前加**同步字符SYN**。
  - 面向比特流的同步通信：每个数据块的头部和尾部用**特殊比特序列如（01111110）**标记开始和结束。

#### 3 信号编码技术

##### 数字数据的模拟信号调制

数字数据在模拟信道上传输，将数字数据调制成模拟信号（**调制解调器**）。

- 调幅ASK：用两个振幅表示两个二进制值。
- 调频FSK：用两个频率表示两个二进制值。
- 调相PSK：用载波的初始相位表示两个二进制值。

<img src="/Users/wangzifan/Desktop/通信网络/pic/调频、调幅、调相示意图.png" alt="调频、调幅、调相示意图" style="zoom:50%;" />

- 正交调相QPSK

##### 数字数据的数字信号编码

- 不归零编码NRZ：正电平表示1，零电平表示0，表示完一个码元后电平无需回到0。（**不能携带时钟信号，无法表示没有数据传输**）
- 曼切斯特编码：低到高跳变为0，高到低跳变为1。（**能携带时钟信号，且可表示没有数据传输**）
- 差分曼切斯特编码

<img src="/Users/wangzifan/Desktop/通信网络/pic/查分曼切斯特编码.png" alt="查分曼切斯特编码" style="zoom:50%;" />

- 4B/5B编码：数据流中每4个bit对应到5个bit——即**用5bit的二进制数来表示4bit的二进制数**，要求每5个bit码组中包含不少于2个“1”。

##### 模拟数据的数字信号编码

对模拟信号进行采样，根据Nyquist定理，采样频率不低于原始信号最高频率的2倍时，采样值就可以包含原信号的全部信息。

##### 模拟数据的模拟信号调制

调幅AM：载波的振幅随模拟数据的数值变化。

调频FM：载波的频率随模拟数据的数值变化。

调相PM：载波的相位随模拟数据的数值变化。

#### 4 信道复用

##### 频分复用

为每个用户分配固定的频带，所有用户在同一时间占用不同的带宽（**频率带宽**）资源。

##### 时分复用

将时间划分为等长的**时分复用帧**，每个用户在每一帧中占用固定序号的时隙。

##### 统计时分复用

每一帧的时隙数小于连接在**集中器**上的用户数，用户数据发往集中器的缓存，集中器扫描缓存放入STDM帧，帧满后发送。

##### 波分复用

##### 码分复用

各用户在相同时间使用相同频带，但**码型**不同，彼此互不干扰。码分多址（Code Division Multiple Access）

<img src="/Users/wangzifan/Desktop/通信网络/pic/CDMA的工作原理.png" alt="CDMA的工作原理" style="zoom:50%;" />

##### 正交频分复用

#### 5 数据交换技术

##### 电路交换

交换系统为通信双方建立一条全程物理通路，以供双方传输信息，直到信息交换结束。

- 优点：数据传输时延小，对用户透明，吞吐量高。
- 缺点：呼叫建立时延大，信道带宽利用率低，难以实施差错控制，难以适应计算机与终端速率不匹配，不适合具有突发性的计算机数据传输。

实现结构：

- 空分交换

<img src="/Users/wangzifan/Desktop/通信网络/pic/电话空分交换.png" alt="电话空分交换" style="zoom:50%;" />

<img src="/Users/wangzifan/Desktop/通信网络/pic/电话多级空分交换.png" alt="电话多级空分交换" style="zoom:50%;" />

- 时分交换

<img src="/Users/wangzifan/Desktop/通信网络/pic/电话交换时分交换.png" alt="电话交换时分交换" style="zoom:50%;" />

##### 报文交换

数据的传输不需要建立连接，数据中包含目的地址，一站一站往下送，采用**存储-转发**机制。

线路利用率高，但是时延大，中间站点需要足够大的缓存。

<img src="/Users/wangzifan/Desktop/通信网络/pic/报文交换.png" alt="报文交换" style="zoom:50%;" />

报文交换的端到端时延：

- 传输时延
- 传播时延
- 存储-转发时延（排队等待时间，存入中间节点的处理时间，从存储器送到输出链路的处理时间）

##### 分组交换

- 与报文交换相似，只是将报文分为若干个**定长的分组**。
- 每个分组中必须包含目的地址，采用**存储-转发机制**。
- 线路利用率高，延时大，发送和接收分组的顺序不一致。

<img src="/Users/wangzifan/Desktop/通信网络/pic/分组交换.png" alt="分组交换" style="zoom:50%;" />

分组=分组头+信息包，用户数据被切分成多个信息包，每个包加上分组头，形成分组。

**分组最佳长度**

- 报文总长度$M$bit，每个分组的分组头$n_h$bit，最大分组长度$K_{max}$。
- 以分组方式传送报文所需的总比特数为$N_{bits}=M+\lceil \frac{M}{K_{max}-n_h}\rceil n_h$
- 传送一个报文所需总时间为**第一个分组**通过前（j-1）条链路+整个报文通过最后一条链路的时间
  $T=\frac{(j-1)K_{max}+N_{bits}}{R}$，$E[T]=\frac{(j-1)K_{max}+E[M]+E[\lceil M/(K_{max}-n_h)\rceil]n_h}{R}$
- 对$K_{max}$求导，令成0，得到分组最佳长度$K_{max}^{opt}=n_h+\sqrt{\frac{E[M]n_h}{j-1}}$

目的节点收到分组后：

1. 卸掉分组头部和校验序列，得到分组数据，写入缓冲器。
2. 根据分组编号检查构成一个完整报文的所有分组是否到齐。
3. 若分组到齐，进行报文重组；否则等待其他分组到达。
4. 报文组装完成后，通知用户接收此报文；同时向发送方返回确认信息。

分组交换的两种机制：

- 数据报（无连接）：每个分组独立处理，独自选择在网络中传输的路由。
- 虚电路（面向连接）：首先要建立传输路径，所有分组均在这个连接上进行传送，帧的顺序和路径都是确定的。

##### 虚电路交换

将电路交换的概念引入到分组传输，面向连接的分组交换，快速分组交换。

- 虚电路的建立：传输方发起连接请求，中间节点根据路径信息建立**交换表**，在交换表内，节点为连接分配一个**虚电路号**，并与输出端口号关联，表示用户信息从该端口号输入，立即从相关联的输出端口输出。
- 虚电路连接的传输：分组中没有目的地址，只有虚电路号，接收分组时只检查其头部，一旦得到其虚电路号，则查交换表，转发至适当的输出端口。



---

### 四 物理层

#### 物理层的基本概念

物理层的功能：与传输媒体的接口，完成传输媒体上信号与二进制数据间的转换，并定义了与传输媒体的接口特性。

#### 物理层下的传输媒体

##### 1 电信领域使用的电磁波频谱

##### 2 导向传输媒体

电磁波被导向沿着**固体媒体**传播

- 双绞线
- 同轴电缆
- 光缆

##### 3 非导向传输媒体

无线传输，根据电磁波波长分为无线电传输/微波传输/红外线和毫米波传输/光波传输。

#### Internet的本地接入

##### 1 拨号接入

- 通过**电话线路**访问远程服务器
- 使用**调制解调器**将数字信号转换成模拟信号
- 必须在某ISP（Internet Service Provider，互联网服务提供商）注册成为合法用户
- 服务器采用DHCP协议，为接入着分配一个临时的IP地址

##### 2 ADSL接入

##### 3 Internet over Cable

##### 4 无线接入



---

### 五 数据链路层

#### 1 数据链路层概述

定义：数据链路层的目的是为了提供功能上和规程上的方法，以便建立、维护和释放网络实体间的数据链路。

> 需要数据链路层的理由：
>
> - 传输数据的信道不可靠，不能保证所传数据无差错。
> - 需要对数据发送端进行流量控制。
> - 广播信道通信需要对信道进行分配。

- 物理链路：有线/无线的传输通路，是一段无源的的点到点的物理连接，中间没有任何交换节点。
- 数据链路：包括一条物理连接和为实现数据传输而在两端配置的**硬件及相关通信协议**，采用复用技术时一条物理链路对应多条数据链路。

数据链路层的功能：在物理层提供的通信线路连接和比特流传输功能的基础上，负责**在两个相邻节点间**建立、维护和拆除链路，并通过**差错控制、流量控制**将不可靠的物理链路改造成无差错的数据链路。

- 对网络层提供严格定义的服务接口，在两个网络实体之间提供**数据链路连接的建立、维持和释放**
- 将需要传输的比特组装成**帧（frame）**（数据链路层中的数据单元）
- 控制帧在物理链路上的传输，包括**帧的同步、传输差错、调节帧的流速**。

##### 数据链路层的服务类型

- 无应答式无连接的服务：接收方收到数据帧后无需回复确认，数据传输前后无需建立和释放连接。
- 应答式无连接的服务：使用前后不需要建立和释放连接，每帧传输必须得到确认。
- 面向连接的服务：使用前后分别需要建立和释放连接，每帧的传输必须得到确认。

#### 2 帧的构成

组帧方法：

- 帧的定界--识别一个完整的帧。
- 帧的再同步--传输差错导致前帧丢失时，能识别出后一个帧的开始。

##### 2.1 字符计数法

帧的第一个字节存放帧的长度

<img src="/Users/wangzifan/Desktop/通信网络/pic/组帧-字符计数法.png" alt="组帧-字符计数法" style="zoom:50%;" />

一旦帧长度出错，将无法再同步。

##### 2.2 带字符填充的起始字符和终结字符法

- 用特殊的字符作为帧头和帧尾界符（面向字符，即数据由键盘输入，不会出现FLAG）

<img src="/Users/wangzifan/Desktop/通信网络/pic/组帧-带字符填充的起始:终结字符法.png" alt="组帧-带字符填充的起始:终结字符法" style="zoom:50%;" />

帧的再同步：接收方一旦丢失了一个FLAG(7E)，只需要继续搜索下一个FLAG就可以重新确定帧的边界。

- 字符填充法

面向字符的帧格式不适宜传输数据中包含二进制数的帧，在二进制数中偶然出现的FLAG前面再插入一个ESC(1B)

##### 2.3 带位填充的起始/终结标志法

**面向二进制位**，不论是字符还是二进制位串全部一字排开，用特殊位串**01111110**作为帧的分隔符，具有帧的再同步能力。

当帧的数据中出现标志符时，在连续的5个1后自动插入一个0，接收方自动删除5个1后的0。

##### 2.4 物理层编码违例法

曼切斯特编码中，低-高电平表示0，高-低电平表示1，低-低/高-高作为帧界符。

#### 3 差错控制

常用差错控制方法：

- 前向差错控制/前向纠错（FEC）：接收端检测到接收信息出错后，通过运算确定差错的具体位置并纠正。
- 反馈重发/自动重发请求（ARQ）：接收端检测到出错，通过反馈信号要求发送端重发原信息。
- 纠检混合的差错控制方式：接收端对少量的差错自动纠正，对超过纠正能力的差错反馈重发。

##### 3.1 差错检测和纠正

原理：通过**信道编码**，在原有数据中添加**冗余度**，从而检测或纠正传输中的错误。

码字的结构：

- 分组码：将整个信息分成组，每组通过线性变化得到校验位，附加在信息位后面（校验位只对本组信息位校验）。
- 卷积码：校验位不仅校验本分组，还对前后分组的信息位起校验作用。

**汉明纠错码**

汉明距离：两个码子不同的位数；编码的汉明距离：所有码字汉明距离的最小值。

> 汉明定理：
>
> - 编码的汉明距离满足$d\ge 2t+1$，则该编码可以纠正任何t位（及以下）的错误。
> - 编码的汉明距离满足$d\ge e+1$，则该编码可以检出任何e位（及以下）的错误。
> - 编码的汉明距离满足$d\ge 2t+e+1$，则该编码可以纠正任何t位（及以下）的错误，并检出e位（及以下）的错误。

位置符合形式xxx1的归到P1，同理分成四组，每组都有一个校验位。

计算每组的二进制和，偶校验情况可以得到位置，奇校验取反得到位置。

**校验和**

将数据作为二进制序列，划分成等长的段，每段相加，进位加到最后的校验和中。

**循环冗余码**

- 一个k位的帧看作k-1次多项式
- 设定生成多项式G(x)，n阶
- 求x^n^M(x)/G(x)的余式R(x)，R(x)为M(x)的CRC码
- 发送数据为x^n^M(x)+R(x)
- x^n^M(x)+R(x)=x^n^M(x)-R(x)能被G(x)整除，接收方只要计算CRC得0即正确

##### 3.2 反馈重发差错控制

- 肯定确认：接收端对收到的帧校验正确，回送ACK，发送端收到ACK后知道传输成功。
- 否定确认：接收端收到帧后校验错误，回送NAK，发送端收到NAK后重发该帧。
- 超时重发：发送端发出帧后开始计时，规定时间没有收到ACK/NAK，则认为帧丢失或确认信号丢失，重发。

**ARQ（Automatic Repeat Request）方案**

- 等待式ARQ：源端在发送下一帧前必须等待确认，确认信号丢失或帧丢失导致重传，数据帧用0、1交替编号，ACK也交替编号，防止同一帧接收两次。

> 连续重发请求：发送端连续发送一系列信息帧，不等前帧确认就发出下一帧。
>
> - 回退N帧ARQ
> - 选择性重发ARQ

- 回退N帧ARQ

<img src="/Users/wangzifan/Desktop/通信网络/pic/回退N帧ARQ.png" alt="回退N帧ARQ" style="zoom:50%;" />

- 选择性重发ARQ

<img src="/Users/wangzifan/Desktop/通信网络/pic/选择性重发ARQ.png" alt="选择性重发ARQ" style="zoom:50%;" />

##### 通信效率

链路的有效速率R~e~=正确接收的比特数/传输这些比特的总时间。

通信效率$\eta=\frac{R_e}{R}$，R为链路传输速率。

传输中每位出错概率为p，则长度K的消息出错概率为$p_e=1-(1-p)^K$。

$P[需j次传输]=p_e^{j-1}(1-p_e)$。

平均传输次数$N_T=\sum_{j=1}^{\infty}jp_e^{j-1}(1-p_e)=\frac{1}{1-p_e}$。

传输一帧的时间$T_s=\frac{K+n_a}{R}+2(t_p+t_{ta})$

<img src="/Users/wangzifan/Desktop/通信网络/pic/传输一帧所需时间.png" alt="传输一帧所需时间" style="zoom:50%;" />

- 等待式ARQ的通信效率：

$$R_e=\frac{K-n_{header}}{N_T\cdot T_s}=\frac{K-n_h}{\frac{1}{1-p_e}[\frac{K+n_a}{R}+2(t_p+t_{ta})]}\approx\frac{K}{\frac{1}{1-p_e}(T+2t_p)}$$

以帧的传输时延T为单位，传播时延t~p~=aT，则$R_e\approx\frac{K(1-p_e)}{(1+2a)T}$，$\eta=\frac{R_e}{R}=\frac{1-p_e}{1+2a}$

> 一次正确传输了(1-p~e~)个帧，用掉了一个帧的传输时延+2个传播时延(1+2a)T。

- 回退N帧ARQ的通信效率

每错一次多发N帧，平均每帧传输次数$N_T=\sum_{i=0}^{\infty}(N\cdot i+1)p_e^i(1-p_e)=1+\frac{Np_e}{1-p_e}$。

$R_e=\frac{K-n_h}{(1+\frac{Np_e}{1-p_e})T}$，$\eta=\frac{(1-p_e)(K-n_h)}{[1+(N-1)p_e]K}$

回退帧数$N=\lceil \frac{T_s}{K/R}\rceil$，其中$T_s=\frac{K+n_a}{R}+2(t_p+t_{ta})$。

- 选择性重发ARQ的通信效率

$R_e=\frac{K-n_h}{\frac{1}{1-p_e}\cdot \frac{K}{R}}$，$\eta=\frac{(1-p_e)(K-n_h)}{K}$

#### 4 滑动窗口式流量控制

主要思想：

- 允许连续发送多个帧而无需逐个等待应答；
- 每个帧包含一个序号（n位），传送过程中已确认收到的帧的序号可以循环使用；
- 在发送端和接收端分别设置**发送窗口**和**接收窗口**。

##### 滑动窗口工作原理

发送端：

- 始终保持一个已发送但尚未确认的帧的序号表
- 发送窗口：
  - 对应于当前允许发送的帧的序号范围。
  - 发送窗口的前沿：表示可以发送的帧的最大序号。
  - 发送窗口的后沿：表示可以发送的帧的最小序号。（即已发送未确认序号表中最大序号+1）
  - 发送窗口大小=前沿-后沿+1。
  - 每发送一个帧（后沿），后沿+1；每接收到一个正确响应帧，前沿+1。

接收端：

- 用接收窗口表示允许接收到信息帧，落在窗外的帧均丢弃。
- 接收窗口：
  - 大小固定，且不一定与发送窗口相同。
  - 前沿表示允许接收的帧的最大序号；后沿表示允许接收的帧的最小序号。
  - 如果序号等于后沿的帧被正确接收，前沿+1，后沿+1，滑动窗口大小不变。

##### 基于确认的窗口滑动

- 当接收窗口保持不动时，发送窗口不会前进；只有接收窗口前进后（发送确认），发送窗口才能前进。
- 确认方式
  - 接收端一收到正确帧，就立即发送一个确认帧。
  - 累积确认：为减少开销，接收端在连续收到几个正确的帧后，对**最后一个**数据帧发回确认。
  - 捎带确认：在接收方向发送方发送数据时，捎带对前面收到的帧进行确认。

滑窗流控的链路利用率

$$\eta=\min\{\frac{W}{1+2a+n_a/K},1\}\approx\min\{\frac{W}{1+2a},1\}$$，忽略ACK长度

#### 5 数据链路层协议实例

##### HDLC--高级数据链路控制

High Level Data Link Control

- 非平衡配置：由一个主站及若干从站组成，主站控制数据链路的工作过程并发出命令，从站接受命令发出响应。
- 平衡配置：链路两端的两个站都是组合站，同时具有主战和从站功能，每个组合站都能发出命令和响应。

**HDLC的帧格式**

| 位数 | 域                 | 作用                                                   |
| ---- | ------------------ | ------------------------------------------------------ |
| 8    | 帧标志序列01111110 | 帧的分隔符，线路空闲时也用来填充                       |
| 8    | 地址域             | 总线型多终端时是终端的站号；点对点时用来区分命令和响应 |
| 8    | 控制域             | 定义帧的类型、序号等                                   |
| 任意 | 数据域             | 用户数据                                               |
| 16   | 校验码             | CRC码                                                  |
| 8    | 帧标志序列01111110 |                                                        |

**HDLC的帧类型**

- 信息帧

控制域 |0|Seq（当前发送帧号）|P/F|Next（捎带确认帧号）|

- 监控帧

控制域｜10｜00/01/10/11｜P/F｜捎带确认帧号｜

- 无序号帧

控制域｜11｜...｜

用于控制链路本身，如呼叫、确认、断开连接等。

**HDLC的操作流程**

- 初始化：通信双方发送**无序号帧**，协商确定使用的选项（工作方式，序列号位数），初始化一条数据链路。
- 数据传输：双方用**信息帧**发送用户数据，用**监控帧**进行流控制和错误控制。
- 断开连接：用**无序号帧**断开连接。

##### PPP--点对点协议

**功能**：差错检测，支持多种协议，支持多种链路类型，连接时允许协商IP地址，允许身份认证。**不提供纠错、流量控制、序号、多点线路**。

PPP协议提供了串行点对点链路上传输数据报的方法，包括三个部分：

- 成帧方法：将IP数据报封装到串行链路，支持异步链路和同步链路。
- 扩展的链路控制协议：用于建立、配置和测试数据链路的连接。
- 网络控制协议簇：支持各种网络层协议，每个协议支持不同的网络层协议。

PPP的帧格式（PPP是面向字符的协议，以字节为单位）

| 域     | 字节数                   | 值                                   |
| ------ | ------------------------ | ------------------------------------ |
| 标志域 | 1                        | 01111110                             |
| 地址域 | 1                        | 固定为11111111                       |
| 控制域 | 1                        | 缺省为00000011，即无序号帧，无需确认 |
| 协议域 | 1/2                      | 不同协议有不同代码                   |
| 载荷域 | 变长，缺省为最长1500字节 | 用户数据                             |
| 校验和 | 缺省为2字节              | **头部**的校验和                     |
| 标志域 | 1                        | 01111110                             |

PPP的链路控制协议LCP（Link Control Protocol）提供了建立、配置、维护、终止点对点链接的方法。

- 链路的建立和配置协调
- 链路质量检测
- 网络层协议配置
- 关闭链路

LCP帧的类型：链路建立帧/链路终止帧/链路维护帧。

PPP的工作过程

1. 发送端PPP首先发送LCP帧，以配置和测试数据链路。
2. LCP建立好数据链路并协调好所选设备后，发送端PPP发送NCP帧，选择和配置网络协议（**分配IP地址**）。
3. 配置好的链路一直保持通信状态，直到LCP帧或NCP帧明确提示关闭链路。

#### 6 介质接入控制

##### 6.1 广播信道的分配

- 静态分配：将广播信道为每个用户分配一个子信道。信道利用率低，用户数少于信道数的情况，信道不足的情况，计算机通信突发性。
- 动态分配
  - 集中式：站点需要中央监控站的允许才能使用信道；分布式：所有站点共同完成信道接入控制，动态决定发送数据的顺序。
  - 循环式：每个站轮流等待机会；预约式：信道使用时间划分为时隙分给每个站点；竞争式：各个站点自由竞争发送机会。

##### 6.2 查询技术

查询技术是一种信道访问技术，需要一个**中心控制站**，中央控制站周期性地向各终端或工作站发送查询帧。各用户只有当被控制站查询时才能发送信息；没有被查询时，信息只能在本地站中排队等候。

> 一般适用于集中式拓扑结构的网络，如树型、星型。

roll-call查询：中央站为每个站产生查询帧，逐个查询各站点。

<img src="/Users/wangzifan/Desktop/通信网络/pic/roll-call查询流程.png" alt="roll-call查询流程" style="zoom:50%;" />

hub查询：中央站产生一个查询帧，该查询帧在各站中按序传递

<img src="/Users/wangzifan/Desktop/通信网络/pic/hub查询.png" alt="hub查询" style="zoom:50%;" />

探查法Probing

<img src="/Users/wangzifan/Desktop/通信网络/pic/探查法.png" alt="探查法" style="zoom:50%;" />

站点总数$N=2^n$，分为$2^{n-j}$组，每组$2^j$个站点，自适应查询关键是j的选取。

纯查询：j=0，共需$2^n$查询，与要发送数据的站点个数无关。

纯探查：j=n，只有一个站发送数据时需查询2n+1次，所有站都发送数据时需查询2^n+1^-1次。

##### 6.3 ALOHA

**随机接入协议**，控制多个用户公用一条信道。纯ALOHA（P-）和时隙ALOHA（S-）。

**纯ALOHA**

工作原理：

- 任何一个站都可以在帧生成后立即发送。
- 发送站通过信号的反馈，检测信道，检查是否发送成功。
- 如发送失败，经**随机延时**后再次发送。

纯ALOHA易受冲突时间2T（T为传输1帧的时间）。

设帧发送的平均值为G帧/帧时，任一帧时内生成k帧（包括需重发的帧）的概率服从泊松分布$P_k=\frac{G^k}{k!}e^{-G}$，一个帧时生成0帧的概率$P_0=e^{-G}$。

两个帧时产生的平均帧数为2G，则2T间隔内至少有别的站发一帧的概率（即冲突）为$1-2e^{-2G}$。

则T时间内需重发的平均帧数$R=G(1-e^{-2G})$，$G=S+R=S+G(1-e^{-2G})\rightarrow S=Ge^{-2G}$。

在G=0.5时，吞吐量S达到最大值，$S_{max}=\frac{1}{2e}\approx 0.184$。

**时隙ALOHA**

- 将时间轴分成固定的时隙，各站点只能在时隙的起始时刻发送帧，如发送失败，发送站经随机时隙的延迟后再发送。
- 在同一个时隙内产生的帧将在下一时隙开始时刻产生冲突，冲突危险区为T。

在T内没有产生其他帧的概率为$P_0=e^{-G}$，此时不会冲突，$S=GP_0=Ge^{-G}$。

G=1时吞吐量最大，$S_{max}\approx 0.368$。

##### 6.4 CSMA

Carrier Sense Multiple Access，载波侦听多路访问，在发送数据前先侦听信道，若信道正忙，则不发送或继续侦听，或随机等待一段时间再进行侦听与发送。若信道空闲，则根据策略发送或暂不发送。

- 非持续型CSMA

每个站发送前侦听信道，空闲则发送；忙则停止侦听，**延时一个随机时隙数**后再次侦听。

缺点：在延迟时隙没有结束前，即便信道空闲也不会发送任何信息，限制了信道利用率提高。

- p-持续型CSMA

先侦听信道，忙则等到下一时隙；空闲则以**概率p**发送，以概率**q=1-p**把延至下一时隙发送，直至发送成功。通常p为0.03和0.1。

优点：既考虑到尽快使用已空闲的信道，又考虑到发送帧时的主动退避，在性能上比非持续型CSMA好。

- 1-持续型CSMA

先侦听信道，忙则等待并**持续侦听**，一旦空闲立即发送。如冲突则延时一随机时隙数后重新发送。相当于p-持续型CSMA的极端情况，p=1。

缺点：轻载时性能较好，重载时性能急剧变坏，性能比非持续CSMA差。

<img src="/Users/wangzifan/Desktop/通信网络/pic/CSMA不同方式性能.png" alt="CSMA不同方式性能" style="zoom:50%;" />

设系统中共有N个站，每个站发送帧的概率为p，有一个站发送成功的概率为$A=Np(1-p)^{N-1}$，

则$A_{max}=(1-\frac1N)^{N-1}$，$P[需发送j次]=(1-A)^{j-1}A$，$N_R=\sum_{j=1}^{\infty}j(1-A)^{j-1}A=\frac1A$

$S=\frac{1}{1+2a(1/A-1)}$，2a是冲突一次所浪费的两个传播时延，共冲突了1/A-1次。

##### 6.5 CSMA/CD

Carrier Sense Multiple Access / Collision Detection，带冲突检测的载波侦听多路访问

在发送前进行载波侦听，在发送过程中也侦听，检测到冲突后及时中断发送。

**竞争发送方式**

各站点在发送前侦听总线，空闲则开始发送，否则持续侦听直到空闲--**1-持续型CSMA**。

站点发送信息时仍然侦听，进行**冲突检测**，若产生冲突则：

- 停止数据发送：放弃本次发送，延迟一段时间后侦听总线重传。
- 对总线进行干预：继续发送一小段时间（发送小于最小帧长的异常帧），使总线上各站点都知道已经发生了冲突，停止各自的发送。

<img src="/Users/wangzifan/Desktop/通信网络/pic/CSMA:CD发生冲突.png" alt="CSMA:CD发生冲突" style="zoom:50%;" />

> 如一个站点发送并经2$\tau$后没有冲突，即发送成功。

二进制退避：让发生碰撞的站在停止发送数据后，不是再立即发送数据，而是推迟一个随机时间（退避）。

**无冲突接收**

发送站点检测到冲突后干预信道，继续发一个32位的**不完全帧**，小于最短的信息帧长度。接收站点收到不完全帧时就得知了冲突，于是把已收到的信息作为错误信息处理。

<img src="/Users/wangzifan/Desktop/通信网络/pic/CSMA:CD竞争发送和无冲突接收.png" alt="CSMA:CD竞争发送和无冲突接收" style="zoom:50%;" />

##### 6.6 令牌类接入控制

令牌环工作原理

<img src="/Users/wangzifan/Desktop/通信网络/pic/令牌环工作原理.png" alt="令牌环工作原理" style="zoom:50%;" />

令牌总线的逻辑环

<img src="/Users/wangzifan/Desktop/通信网络/pic/令牌总线的逻辑环.png" alt="令牌总线的逻辑环" style="zoom:50%;" />

#### 7 局域网标准

##### 7.1 IEEE局域网标准

IEEE802标准

- 物理层：与OSI/RM物理层对应。
- 介质介入控制层（MAC）：管理通信实体接入信道建立数据链路的控制过程。
- 逻辑链路控制层（LLC）：提供服务访问点，以复用的形式建立多点--多点之间的通信连接，包括寻址、差错控制、流量控制等功能。

<img src="/Users/wangzifan/Desktop/通信网络/pic/IEEE局域网参考模型.png" alt="IEEE局域网参考模型" style="zoom:50%;" />

逻辑链路控制子层（Logical Link Control）

- LLC提供确认机制和流量控制
- LLC隐藏了不同802MAC子层的差异，为网络层提供统一的格式和接口。
- LLC提供三种服务选项：不可靠的数据报服务/带确认的数据报服务/可靠的面向连接服务。
- LLC帧头基于HDLC协议。

介质访问控制子层（Medium Access Control）

- 数据封装：成帧/寻址/错误检测
- 介质接入管理：介质分配/争用解决方法

> 分成两个子层的原因：
>
> - 管理多点访问信道的逻辑不同于传统的数据链路控制。
> - 对于同一个LLC，可以提供多个MAC选择。
>
> ——LLC层与局域网形态和传输介质无关，MAC层与局域网形态和传输介质直接相关。

##### 7.2 以太网

（1）经典以太网

**集线器**：使用电子器件模拟实际电缆线的工作，各节点发送来的信号通过集线器集中，**集线器将信号进行整形、放大后发送到其它所有节点**，工作在**物理层**。

MAC帧的格式（最常用Ethernet V2）

| 7              | 1                  | 2/6      | 2/6    | 2                                     | 0～1500 | 0～46    | 4        |
| -------------- | ------------------ | -------- | ------ | ------------------------------------- | ------- | -------- | -------- |
| 前导码10101010 | 帧开始字符10101011 | 目的地址 | 源地址 | 表示上层使用的协议，IP=800H，ARP=806H | 数据    | 填充字符 | 校验序列 |

MAC地址：硬件地址，6个字节48位，IEEE的注册管理机构RA向厂家分配高24位，低24位厂家指派。

适配器从网络上每收到一个MAC帧就首先用硬件检查帧中的MAC地址，如果是发往本站的（单播一对一，广播一对全体，多播一对多）则收下，否则丢弃。

以混杂方式（promiscuous mode）工作的以太网适配器只要听到有帧在以太网上传输就都收下来。

校验序列：4个字节CRC。

填充字段保证帧的最短长度为64个字节。（如果发送端在2$\tau$时间内帧已经发送结束，即便冲突也无法检测，最短帧长应与2$\tau$相当）

CSMA/CD中的二进制指数退避算法：经i次冲突后，双方在0～2^i^-1中选择一个时隙数，等待后重发。

**802.3的性能**

设有k个站点参与信道竞争，每个站点在每个时隙中的发送概率为p，信道效率=每帧发送时间P/（每帧发送时间P+平均竞争时间T）

平均竞争时间=平均竞争时隙数*时隙长度

某时隙内，站点成功获得信道的概率为$A=kp(1-p)^{k-1}$，

$P[竞争时隙数为j]=A(1-A)^{j-1}$，平均时隙数=$\sum_{j=0}^{\infty}jA(1-A)^{j-1}=\frac1A=e,(k\rightarrow \infty)$。

信道效率=$\frac{P}{P+2\tau /A}=\frac{P}{P+2\tau e}$

（2）交换式以太网

**以太网交换机**

- 交换机有高速背板，可插入若干模块
- 每个模块实际上是一个小规模局域网，**一个模块就是一个共享域**（以太网中即**冲突域**）。
- 一个模块上任一时刻只能有一个站点发送，但分属不同模块上的端口可并行工作；模块内共享，模块间交换——**端口之间帧的传输不受CSMA/CD的限制**。
- 当每个模块都退化成一个端口时，该交换机是**全交换**的。

（3）快速以太网

（4）千兆以太网

（5）万兆以太网

##### 7.3 无线局域网

（1）802.11无线局域网的组网模式

802.11定义了两种组网模式：

- Ad-Hoc模式：所有的移动站之间互相平等，每个节点既是主机又是路由器。
- Infrastructure模式
  - 基本服务集BSS：由一个基站和若干移动站组成，基站称为AP（Access Point），一个BSS覆盖的范围称为一个基本服务区BSA。
  - 扩展服务集ESS：多个BSS通过一个分布式系统DS互联而成，成为逻辑上的局域网；一般DS是一个有限主干局域网，通常表现为以太网。BSS间的通信通过DS实现，BSS在LLC子层上相统一。

（2）802.11物理层

（3）802.11MAC层协议

带冲突避让的载波多路侦听CSMA/CA（CSMA with Collision Avoidance）

> 无线局域网不能使用CSMA/CD的原因
>
> - CSMA/CD要求每个站点在发送数据的同时不断检测信道，对无线局域网中的设备来说花费过大。
> - 即便发送端能实现碰撞检测，接收端仍可能发生碰撞。

- 任何站在完成发送后必须等待一段很短的时间才能发送下一帧，这段时间称为帧间间隔IFS（InterFrame Space）。间隔长短取决于帧类型，高优先级帧等待时间短，低优先级帧等待时间长。
- 争用：当信道由忙转为空闲时，任何站在发送数据前，都要采用二进制退避算法，低i次退避从2^2+i^个时隙数中选取。

<img src="/Users/wangzifan/Desktop/通信网络/pic/CSMA:CA.png" alt="CSMA:CA" style="zoom:50%;" />

#### 8 数据链路层交换

##### （1）局域网的扩展

物理层上的局域网扩展——使用多个集线器连成更大的局域网，用集线器hub扩展的局域网都在一个冲突域内。

数据链路层上的局域网扩展——利用数据链路层交换设备扩展，网桥/交换机。

<img src="/Users/wangzifan/Desktop/通信网络/pic/网桥和交换机.png" alt="网桥和交换机" style="zoom:50%;" />

##### （2）网桥Bridge

工作在数据链路层，连接多个局域网，每个端口连接的所有主机称为一个**网段**，所连接的各局域网数据链路层的MAC子层可以不相同。

网桥的工作原理：根据MAC帧的目的地址对收到的帧进行**存储和转发**。

- 过滤帧：当网桥收到一个帧，先检查目的MAC地址，依据转发表确定将该帧转发到哪一个接口。
- MAC帧的转换：当帧的类型与目的网络的类型不一致，进行MAC帧的转换。
- MAC帧的传输速率调整：当源网络和目的网络传输速率不一致，通过存储和转发调整发送速率。

> 网桥的优点：
>
> - 过滤通信量——使各网段称为隔离开的碰撞域
> - 扩大了物理范围
> - 提高了可靠性
> - 可互连**不同物理层、不同MAC子层、不同速率**的局域网
>
> 缺点：
>
> - 存储转发增加了时延
> - 在MAC子层没有流量控制功能
> - MAC子层不同的网段桥接在一起时时延更大
> - 只适合于用户数不太多和通信量不太大的局域网，否则可能产生**广播风暴**

网桥和集线器的不同：

- 集线器在转发帧时，不对传输媒体进行冲突检测，集线器所连的整个网络为一个冲突域。
- 网桥对接收帧进行过滤，在转发前必须执行CSMA/CD算法，冲突域限制在所连的各个LAN内，转发过程中出现碰撞必须停止发送和退避。

**透明网桥**：LAN的站点并不知道所发的帧经过哪些网桥，网桥对各站点不可见，网桥依据转发表转发数据帧。

转发表的组成：（MAC地址，接口，时间），记录帧进入网桥的时间。

转发表的建立：**自学习算法**，即逆向学习法，从接口x收到了来自A的帧，那么从x出发一定可以把帧传送到A。初始转发表为空，网桥每收到一个帧，检查源MAC地址，不在转发表中，则记录源MAC地址，接收接口和时间，在转发表中则更新时间。

网桥收到一个帧后：

- 进行**自学习**更新转发表（新增项或更新时间）。
- 查找转发表中有无目的地址的匹配项
  - 无，通过全部其它接口转发该帧（扩散算法）
  - 有，对比转发表中匹配项的接口和该帧进入网桥的接口，相同（源/宿同一网段）则丢弃，不同则转发。

**生成树网桥**：在物理上存在回路的拓扑中，生成一棵在逻辑上无回路的树，即生成树。

**远程网桥**：连接两个或多个远距离的LAN，每对网桥见采用**点到点线路**连接，可以将MAC帧作为载荷封装到点到点协议帧里，也可以源网桥出去掉头尾作为载荷，到目的网桥重新生成MAC帧。

**源路由网桥**：源路由网桥在发送帧时将路由信息放在帧首部中，依据该路由信息转发帧。

##### （3）交换机Switch

以太网交换机实质上是一个**多接口的网桥**，工作在**数据链路层**。每个接口连接单个主机或集线器，**全双工**。当主机通信时，交换机可以同时连通多对端口，使每一对主机如同独占通信媒体。每个接口有自己的冲突域，交换机永远不会由于冲突而丢弃帧。**即插即用**，**自学习算法**建立内部转发表。

交换机利用地址学习的方法动态建立和维护端口号/MAC地址映射表。

交换机的帧转发方式：

- 直接交换方式：接收并检测到目的地址就立即将该帧转发出去，**无检错和调整速率**。
- 存储转发方式：交换机先接收完整数据帧，进行差错检测再转发，**可以检错和调整速率**。
- 改进的直接交换方式：接收数据帧的前64字节，判断字头正确再转发。

<img src="/Users/wangzifan/Desktop/通信网络/pic/交换机独占带宽.png" alt="交换机独占带宽" style="zoom:50%;" />

##### （4）虚拟局域网VLAN

局域网中使用网桥和交换机来分隔网段，使用路由器来划分子网。

网段和子网的区别：

- 网段，一个网段即一个冲突域，将若干网段通过交换机/网桥连接，交换机/网桥的每个端口连接一个网段，**网段是链路层概念**。一个网段内的主机是一个冲突域，所有的主机是一个广播域。
- 子网，一个子网即一个广播域，将若干子网通过路由器连接，路由器的每个端口连接一个子网，**子网是链路层概念**。一个子网是一个广播域。

VLAN采用交换机技术，将原有网络分成若干个**逻辑子网**，一个VLAN是一个广播域



---

### 六 网络层

#### 1 网络层概述

**网络层的定义**：在计算机通信系统之间提供建立、保持和终止网络连接的手段，并为传输层实体通过网络连接交换网络服务数据单元提供功能和规程方面的手段。

**网络层的功能**：

- 网络互联
- 路由选择
- 流量控制和拥塞控制
- 为上层提供服务，服务应与路由器技术无关，路由器的数量、类型、拓扑结构应对传输层不可见，传输层获得的网络地址应采用统一编址方式，且允许跨越多个LAN和WAN。

**网络层服务的类型**：

- 面向连接的服务：将复杂的功能放在网络层，包括连接建立、数据传输、连接释放三个阶段。
- 无连接服务：将复杂的功能放在传输层，不在端系统之间建立连接。

**服务原语**：是服务用户和服务提供者之间的抽象且与实现无关的交互。可以分为请求、指示、响应、证实四种类型。

<img src="/Users/wangzifan/Desktop/通信网络/pic/OSI网络层服务原语.png" alt="OSI网络层服务原语" style="zoom:50%;" />

面向连接服务原语

<img src="/Users/wangzifan/Desktop/通信网络/pic/面向连接服务原语.png" alt="面向连接服务原语" style="zoom:70%;" />

无连接服务原语

- N_Unitdata.request(源地址，目的地址，QoS，用户数据)
- N_Unitdata.indication(源地址，目的地址，QoS，用户数据)

**网络层的内部结构**

- 虚电路Virtual Circut
  - 在发送数据前建立连接，一般等待时间为RTT。
  - 连接请求包含完整的目的地址，但每个数据报文只携带很小的VC标识，每个包的开销很小。
  - 如果链路或交换机故障，连接将中断，必须建立新的连接。
- 数据报Datagram
  - 没有连接建立阶段
  - 每个报文包含完整的目的地址
  - 每个报文独立地被转发
  - 转发表由路由协议动态生成

> 虚电路和数据报都属于**分组交换**，采用**存储-转发机制**。

**虚电路和数据报子网的比较**

|              | 数据报子网                         | 虚电路子网                                                 |
| ------------ | ---------------------------------- | ---------------------------------------------------------- |
| 初始建立连接 | 不需要                             | 需要                                                       |
| 地址         | 每个分组包含完整的源地址和目的地址 | 每个分组含有一个短的虚电路号，目的地址仅在连接建立阶段使用 |
| 状态信息     | 子网不存储状态信息                 | 以建立的虚电路占用子网路由表空间                           |
| 路由选择     | 每个分组独立选择                   | 虚电路一旦建立，路由就确定                                 |
| 分组顺序     | 到达顺序可能与发送顺序不同         | 总是按发送顺序到达目的站                                   |
| 节点故障影响 | 节点崩溃会丢失分组，无其它影响     | 所有经过失效设备的虚电路都会被终止                         |
| 差错处理     | 由主机承担                         | 对主机透明（由通信子网承担）                               |
| 拥塞控制     | 由主机负责                         | 由通信子网负责                                             |
| 功能复杂点   | 传输层                             | 网络层                                                     |
| 适用方式     | 面向连接和无连接服务               | 面向连接服务                                               |

#### 2 路由选择

**路由选择的定义**：在分布式分组交换网中每个节点具有自动选择最佳路径的能力。

路由选择与流量控制的交互

<img src="/Users/wangzifan/Desktop/通信网络/pic/路由选择和流量控制的交互.png" alt="路由选择和流量控制的交互" style="zoom:50%;" />

**路由表**：对每个目的节点指出分组应该发向的下一节点。

##### 路由选择算法

随机路由选择：将收到的分组随机选择一个出口转发出去。

- 效率低、时延大，可能造成分组长期在通信子网中滞留。
- 简单、健壮性好。

洪泛式路由选择：完全扩散——将分组向到来线路以外的所有线路转发；选择扩散——向分组目的地方向的若干线路转发。

- 可靠性高，路径最短。
- 重复数据包多，浪费带宽

> 可以在数据包头设置计数器，每经过一个节点减1，减到0时丢弃。
>
> 在每个节点上建立登记表，丢弃重复经过的包。

固定式路由选择（静态路由）：

- 固定式单路由算法：人工计算得出**固定路由表**，简单、实现方便、可以给出最佳路由；不能联机修改、不能适应网络业务量变化和拓扑变化。
- 固定式多路由算法（迂回式路由选择）：任何一对节点间有多条可选路由，最佳/次佳/再次佳等，最佳路由不通或过载，就可以选择其它路由。

最短路径法：Dijkstra算法

自适应路由选择：

- 孤立的自适应路由算法：仅仅孤立地依据节点自身的运行状态（流量和排队）来决定路由，与网络中其它各节点的状态无关。
- 分布式自适应路由选择：在网络**相邻节点**之间，每经过一定时间相互交换一次状态信息，各节点根据相邻节点送来的状态信息修改自己的路由表。可以适应整个网络的状态变化，但是附近节点的状态得到反映较快，远处节点得到反映较慢。
  - 距离矢量D-V算法
  - 链路状态L-S算法

距离矢量D-V算法

每个路由器用向量D~i~和S~i~表示该点到网上所有节点的最短路径距离及路径中它的下一个节点。d~ij~：i到j的最短路径的距离，s~ij~：i到j最短路径上i的下一个节点。则根据邻居集合A的信息，路由表更新方法为：$d_{ij}=\min_{x\in A} \{d_{ix}+d_{xj}\},s_{ij}=x$。

> 距离矢量D-V算法的缺点：
>
> - 交换的路径信息量大。
> - 路径信息不一致。
> - 不适合大型网络。
> - 坏消息收敛速度慢——无穷计算。

<img src="/Users/wangzifan/Desktop/通信网络/pic/距离矢量D-V算法的无穷计算.png" alt="距离矢量D-V算法的无穷计算" style="zoom:50%;" />

克服方法：

- 水平分裂：防止路由器向邻居返回一个从该邻居处获得的最佳路径。对于C点的上方点A，C向其下方点D告知其到A到真正距离，而总是向其上方点B返回无穷大。
- 抑制算法：当发现与相邻节点不通时，不重新选路径，直接将其设置为无穷的。

链路状态L-S算法

- 发现相邻节点，得到其网络地址。路由器启动后向每个点到点线路发送HELLO分组（携带自己的网络地址），线路另一端路由器应答自己的网络地址。
- 测量它到各相邻节点的延迟或开销。发送一个ECHO分组要求对方立即响应，测量来回时间除以2，发送方就可以得到一个延迟估计值。
- 将这些信息组装成分组。
- 把分组发送给所有其它路由器。用扩散法（向邻接的节点）发布链路状态分组。
- 计算到每个路由器的最短路径。用Dijkstra算法，生成一棵以自身为根节点的生成树，得到自身到其它各路由器的最短路径。

优点：路由信息一致性好，坏消息一样传播得快。状态分组长度较短，仅包含相邻节点的距离、序号等，传输消耗的网络带宽不大。由于年龄参数，状态分组的扩散不会无限制，可**适用于大型网络**。

缺点：路由器需要较大存储空间用于存放链路状态分组，计算量大，每次都必须计算最短路径。

#### 3 网络拥塞控制

##### 3.1 网络拥塞的原因

网络拥塞：通信子网中有太多的分组，导致其性能降低的现象。

原因：

- 存储空间不足。
- 带宽容量不足。
- 处理器处理速度慢

<img src="/Users/wangzifan/Desktop/通信网络/pic/网络拥塞.png" alt="网络拥塞" style="zoom:50%;" />

##### 3.2 拥塞控制的基本原理

开环控制：通过良好的设计避免拥塞问题出现，何时接收新的数据报，何时丢弃分组，各节点调度策略等，**与网络中的当前状态无关**。

闭环控制：基于**反馈**的拥塞控制

1. 监视系统检测何时何地发生了拥塞（根据丢包率、队列长度、超时重发包数等）
2. 将拥塞信息传送到拥塞控制点
3. 调整系统操作以更正系统

闭环控制的反馈方式：

- 显示反馈：当某一节点发现拥塞，发送一个回答帧给相关节点，通知它们网络拥塞了。
- 隐式反馈：发送端每发送一个帧就启动一个定时器，规定时间内没收到ACK，就认为帧丢失，丢失率很高就认为网络拥塞。

##### 3.3 拥塞预防策略

**虚电路子网中的拥塞控制**

- 准入控制：拥塞出现，不允许建立新的连接。
- 如果允许建立新的虚电路，则路由选择时要绕过拥塞线路。
- 虚电路建立时，在主机和子网之间协商，子网为数据流**预留资源**。

**数据报子网的拥塞控制**

- 路由器的缓冲队列管理
  - 被动队列管理：拥塞发生后采取措施，丢弃队列中的部分包。
  - 主动队列管理：提前采取措施，随机早期检测（RED），使用平均队列长度衡量拥塞程度，反馈给端系统。

> 随机早期检测（RED）：路由器维持队列的两个参数——队列长度最小门限T~low~和最大门限T~high~。每到达一个数据报，先计算平均队列长度Q~avg~
>
> - Q~avg~<T~low~，将新到达的数据报放入队列。
> - Q~avg~>T~high~，将新到达的数据报丢弃。
> - Q~avg~在T~low~和T~high~之间，按照某一概率p将数据报丢弃。

<img src="/Users/wangzifan/Desktop/通信网络/pic/早期随机检测RED.png" alt="早期随机检测RED" style="zoom:50%;" />

路由器的拥塞通知：

- 警告位方法：当发生拥塞时，在分组的头部设置一位警告位。当分组到达目的主机，传输实体将警告位拷贝到ACK上，告知源主机拥塞的发生，以调整其发送速率。
- 抑制分组：拥塞的路由器直接发送抑制分组给源主机。
- Hop-by-Hop阻塞包：拥塞的路由器发送抑制分组到它的前一站路由器，通知其放慢速率，前一站再发给自己的前一站，直到源主机。

#### 4 网络流量控制

网络流量控制的功能：

- 防止网络拥塞
- 避免死锁——存储-转发死锁，分组重装死锁
- 在用户之间合理分配资源
- 网络及其用户之间的速率匹配

流量控制技术：

- 集中式
  1. 指定网络控制节点收集当前报文流信息
  2. 网络控制节点计算各节点的报文流量分配
  3. 各节点依据报文流量分配，限制报文的输入率
- 由多个或每个网络节点来控制从外部新进入的业务量

> 流量控制和拥塞控制的区别和联系
>
> 区别：
>
> - 流量控制：只在一对给定的发送方和接收方之间，调节某发送点和接收点之间的通信量。
> - 拥塞控制：是一个全局性过程，涉及到网络中的所有主机、路由器的行为，必须使得通信子网能够传送所有待传送数据。
>
> 联系：流量控制限制了进入网络的信息总量，可以缓解网络拥塞。
>
> <img src="/Users/wangzifan/Desktop/通信网络/pic/流量控制对拥塞控制的作用.png" alt="流量控制对拥塞控制的作用" style="zoom:50%;" />

网络流量控制的层次：

- 传输级（端到端级）：保护目的端，防止用户进程缓冲器溢出，由**传输层**协议完成。
- 链路级：保护各条通信链路以及通信链路侧缓冲器，由**链路层**实现。
- 入口级到出口级：保护出口交换机不发生拥塞，由相当于OSI**网络层**的功能实现。
- 入网级：控制外部业务量进入网络。
- 虚电路级：保护使用VC的用户进程。

<img src="/Users/wangzifan/Desktop/通信网络/pic/流量控制的五种级别.png" alt="流量控制的五种级别" style="zoom:50%;" />

#### 5 网络服务质量

##### 5.1 服务质量应用需求

**流flow**：具有同意的源IP、源端口、目的IP、目的端口、协议标识符、服务质量需求的一连串分组。

流的服务质量QoS的指标：可靠性，延迟，抖动，所需带宽。

提供服务质量的方法：

- 提供充足的资源：路由器的处理能力、缓冲区、带宽、在接收端提供缓冲能力以消除抖动。
- 提供均衡路由：把流量分散到多条路径上。

##### 5.2 流量整形

流量整形：调节进入网络的数据流的平均速率和突发性。

**漏桶算法**：使输入流量平滑，控制入网流量。

设漏桶容量为Cbyte，漏桶输出速率为$\rho$Byte/s，则突发速率r与允许突发的时常S的关系为$S=\frac{C}{r-\rho}$。

**令牌桶**——大的突发流量到来时，输出也有适当体现。

- 数据的输出必须持有令牌
- 令牌每个固定时间产生一个，没有被及时使用的令牌存入令牌桶，令牌桶满时丢弃新产生的令牌。
- 突发数据到达时，可以一次使用掉令牌桶内的多个。

<img src="/Users/wangzifan/Desktop/通信网络/pic/令牌桶.jpeg" alt="令牌桶" style="zoom:50%;" />

V：令牌桶容量，$\rho$：令牌到达速率，M：数据最大输出速率，则

最大突发时间长度$S=\frac{V}{M-\rho}$。

##### 5.3 包调度

包调度算法：假定一个流的数据遵循同样的路径，在同一个流的数据包之间以及竞争流之间分配路由器资源。

- 先进先出FIFO或先来先服务FCFS：实现简单，但多个流存在时会互相影响。
- 公平队列FQ：路由器为每个流设置单独的队列，按数据包/字节为发送单位，路由器循环扫描各队列。
- 加权公平队列WFQ：为每个流分配一个权值，依据流的权值分配每个流占用的出口带宽。
- 优先级队列PQ：每个数据包标记一个优先级别，高优先级数据包先发送，相同优先级按FIFO发送。

##### 5.4 准入控制

- 准入控制：网络根据流量特征及所需的资源决定是否接受该流。
- 流规范：一组参数，用来描述流的特征，网络根据这些特征确定所需资源。
- 流参数的协商：发送方生成一个流规范，当这组参数沿着路径传播时，沿途的路由器都会修改这组参数（只能降低，不能提高），当到达接收方，就建立起流参数。

##### 5.5 综合服务

综合服务Integrated Services可对单个的应用会话提供服务质量的保证，主要特点有：

- 资源预留：路由器需要知道不断出现的会话已经预留了多少资源。
- 呼叫建立：需要服务质量保证的会话必须首先在源站到目的站到路径上的每个路由器预留足够的资源，以保证端到端的服务质量要求。

IntServ定义了两类服务：

- 有保证的服务：可保证一个分组在通过路由器时的排队时延有一个严格的上限。
- 受控负载的服务：可以使应用程序得到比通常的“尽最大努力”更加可靠的服务。

IntServ的四个组成部分：

- 资源预留协议RSVP(Resource reSerVation Protocol)
  - 将在沿途的路由器上预留一定的资源，包括带宽、缓冲区、表空间等
  - RSVP是基于接收端，由接收端发起的协议，接收方沿着**组播路由生成树**给组播发送方发送一条资源预留消息，沿途的每一个路由器依据该消息预留资源。
- 接纳控制，用来决定是否同意对某一资源的请求
- 分类器，用来将进入路由器的分组进行分类，根据分类结果将不同组别的分组放入不同的队列
- 调度器，根据服务质量要求决定分组发送的前后顺序。

##### 5.6 区分服务

区分服务（differentiated services, DiffServ）也称为基于类别的服务质量

- 区分服务可由一组路由器提供，这组路由器形成一个**管理域**。
- 每个域中定义一组服务级别（DS级别），即一组转发规则。
- 如果客户订购了区分服务，那么进入到管理域的客户数据包会被标记上**服务类型**子段，用来表示所需的服务级别。

区分服务的特点：

- 不需要为每一流进行端到端的协商和资源预留，而是**将若干个流根据其DS值聚合成少量的流**。
- 区分服务仅为单跳行为，由该管理域内的路由器提供服务，而不是整个网络的服务保证。
- 路由器内对DS值相同的流按相同的优先级进行转发，简化了路由器内部的转发机制。

##### 5.7 标签交换和MPLS

标签交换Label Switching：在传统的IP网络中添加了**面向连接的特性**，是在尽力而为的传统网络中将数据流按照不同分类选择不同的路径。

- 类似于虚电路方式，在数据包头加上一个标签，一般为转发表中的索引。
- 在中间路由器上根据标签而不是目的地址作为路由，加快转发速度。

MPLS(Multiple Protocol Label Switching)：独立于网络层和链路层，将无连接的数据报转化为面向连接的虚电路交换——2.5层。

MPLS网络的组成：

- 标记交换路由器LSR
- 标记边缘路由器LER
- 标记交换路径LSP

MPLS工作过程

- 建立连接：形成标记交换路径的过程——建立路由表
  - 逐跳路由：每个节点独立为每个**转发等价类**选择下一跳节点。
  - 显示路由：出/入口LER决定LSP的LSR的序列。
- 数据传输：数据分组沿LSP转发的过程——入口LER给IP分组加上标记（将其划分到某一组等价转发类），沿途LSR按标记进行转发，出口LER去掉标签。
- 拆除连接：释放LSP。

#### 6 网络互联

##### 6.1 概念

网络互联也称网际互联，指两个以上的计算机网络，用一种或多种通信处理设备相互连接起来，以构成更大的网络系统。

##### 6.2 功能

- 扩大网络通信范围
- 实现不同网络体系结构、不同传输媒体、不同拓扑结构的网络之间的连接。
- 提高网络系统性能和系统可靠性。

##### 6.3 要求

- 提供网络之间的通信设施
- 提供不同网络上用户间的路由选择
- 提供计费服务
- 在不改变互联网络体系结构的情况下提供各种服务

##### 6.4 类型

LAN-LAN	LAN-WAN	WAN-WAN	LAN-WAN-LAN

##### 6.5 设备

网络互联使用的中间设备

- 物理层中继系统：转发器repeater
  - 物理层设备，在电缆端之间拷贝比特
  - 对弱信号进行放大或再生，延长传输距离。
- 数据链路层中继系统：网桥/交换机
  - 在局域网之间存储-转发帧
  - 网桥可以改变帧格式
- 网络层中继系统：路由器router
- 网络层以上的中继系统：网管gateway，主要实现高层协议的转换。

> 当中继系统是转发器或网桥时，不称为网络互联，因为仍属于一个网络。
>
> 互联网都是指用路由器进行互连的网络。

三层交换机：集成了位于数据链路层的交换机和位于网络层的路由器两者的功能

- 二层交换模块：负责MAC层的寻址和数据帧的传递
- 三层交换模块：负责IP层的寻址
- 硬件转发表：（目的IP地址、VLAN ID、端口、下一跳MAC地址）

三层交换机工作原理：

- 对于待转发的报文，若硬件转发表中有相应转发项，按转发项转发——**二层快速转发**。
- 硬件转发表中没有转发项，利用三层交换模块功能，获得下一跳路由器IP地址，再利用ARP广播请求包，获得下一跳路由器的MAC地址，建立起硬件转发表中的转发项——**三层交换模块**。

两类三层交换技术：

- 三层报文交换技术——每个报文都要经历第三层处理，数据帧到达系统物理接口后，在数据链路层搜索硬件转发表：
  - 若有与目的IP地址相匹配的项，则第二层转发。
  - 若没有，则进入三层交换模块，确定路由，再进入第二次进行转发。
- 三层流交换技术——流中仅第一个报文需要三层交换模块处理
  - 流中第一个报文进入第三层处理，识别流，确定路由
  - 之后，第一个报文和后继报文依据选定的路由在第二次转发——**直通路由技术，即路由一次，交换多次**。

#### 7 因特网中的网络层

##### 7.1 IP协议

（1）IP协议簇

| 网际协议         | IP   | Internet Protocol                   |
| ---------------- | ---- | ----------------------------------- |
| 地址解析协议     | ARP  | Address Resolution Protocol         |
| 逆地址解析协议   | RARP | Reverse Address Resolution Protocol |
| 网际控制报文协议 | ICMP | Internet Control Message Protocol   |
| 网际组管理协议   | IGMP | Internet Group Management Protocol  |

（2）IP报文格式

<img src="/Users/wangzifan/Desktop/通信网络/pic/IP报文格式.png" alt="IP报文格式" style="zoom:50%;" />

包括20个字节的固定部分和最长40字节的可选部分

- IHL：IP报文头长度，5～15（32bit）。
- DF：Don't Fragment，所有机器必须能够接受小于等于576字节的报文。
- MF：More Fragments，除最后一个分片外所有分片都要置MF位。
- 协议域：上层为哪种传输协议，TCP-6，UDP-17，ICMP-1，OSPF-89
- 头校验和：只对IP报头做校验，以16位为单位相加，进位加到末尾，和再求反。

IP可选项，长度必须为4字节的倍数，不够则填充，最长为40字节。

| 可选项                | 描述                                       |
| --------------------- | ------------------------------------------ |
| Security              | 规定数据包的加密方式                       |
| Strict source routing | 报文必须严格按此路径转发                   |
| Loose source routing  | 报文必须经过给出的路由器                   |
| Record route          | 途径每台路由器都必须附上它的IP地址         |
| Timestamp             | 途径每台路由器都必须附上它的IP地址和时间戳 |

（3）IP报文的分段与重组

MTU：Maximum Transmission Unit。

按MTU的大小及数据包的实际负载长度计算所需段数，分段应满足：

- 各段在不大于MTU的前提下尽量大
- 段长为8字节的整数倍

原数据包的报头作为每段的数据包报头，并修改头部字段，指明：

- 属于原来的哪个报文
- 属于原来报文分段的第几段
- 是否是段尾

IP报文的分段：三个参数

- 标识identifier：16位
  - 发送方每发送一个报文标识+1
  - 各分段的标识相同
  - 源地址+标识来区分各个分段
- 标志flag：3位（一位保留）

| 0    | 保留 |                                                              |
| ---- | ---- | ------------------------------------------------------------ |
| 1    | DF   | 0：表示本报文允许分段<br />1：表示本报文必须完整到达，途中不允许分段 |
| 2    | MF   | 0：表示本段为分组的最后一个段<br />1：表示本段后面还有更多的段 |

- 段偏移fragmentation offset：13位，单位为8Byte。

分段的重组：

- 途中任意路由器都无法重组，重组必须在各分段都到底目的地后才能进行，每个分段可以走不同路径，可以不按顺序到达。
- 互联网遵循尽力而为传送IP报文。

> IP协议采用非透明重组，主机遵循原则：要么重组成功，要么全部丢弃。

（4）IP地址

IP地址是给每个连接着因特网上的主机（或路由器）分配的在全世界范围内唯一的32位的标识符。

IP地址的编址方法

- 分类的IP地址
  - 每一类地址都由两个固定长度的子段组成：网络号net-id--主机号host-id

<img src="/Users/wangzifan/Desktop/通信网络/pic/分类的IP地址.png" alt="分类的IP地址" style="zoom:50%;" />

| 网络类别 | 最大网络数    | 第一个可用网络号 | 最后一个可用网络号 | 网络中最大主机数 |
| -------- | ------------- | ---------------- | ------------------ | ---------------- |
| A        | 126（2^7^-2） | 1.               | 126.               | 2^24^-2          |
| B        | 2^14^-1       | 128.1.           | 191.255.           | 2^16^-2          |
| C        | 2^21^-1       | 192.0.1          | 223.255.255        | 2^8^-2           |

特殊IP地址

| 前缀   | 后缀   | 地址类型 | 用途               |
| ------ | ------ | -------- | ------------------ |
| 全0    | 全0    | 本机     | 启动时使用         |
| 全0    | 主机ID | 主机     | 标识本网络中的主机 |
| 网络ID | 全1    | 直接广播 | 在指定网络上广播   |
| 全1    | 全1    | 受限广播 | 在本地网络上广播   |
| 127    | 任意   | 回送     | 测试               |

私有网络的IP地址

| 地址类别 | 地址                        | 固定部分 |
| -------- | --------------------------- | -------- |
| A        | 10.0.0.0-10.255.255.255     | 10.      |
| B        | 172.16.0.0~172.31.255.255   | 172.0001 |
| C        | 192.168.0.0~192.168.255.255 | 192.168. |

- 划分子网

  - 划分成的所有子网对外仍像一个网络。
  - 从主机号借用若干位作为子网号，IP地址::={<net-id>,<subnet-id>,<host-id>}。
  - 子网之间的数据传输需要通过路由器。

  IP地址 & 子网掩码 = 网络地址

- 无分类编制CIDR

  无分类域间路由选择CIDR（Classless Inter-Domain Routing）

  - CIDR消除了ABC类以及划分子网的概念
  - CIDR使用各种长度的网络前缀来指明网络
  - 两级编址

  最长前缀匹配

  - 使用CIDR时，路由表中的每个项目由网络前缀和下一跳地址组成，查找路由表时可能得到多个匹配结果——**网络前缀可能相同**。
  - 应当从匹配结果中选择具有最长网络前缀的路由

（5）IP层转发报文的流程

分类IP地址的分组转发过程

1. 从数据报的首部提取目的主机的IP地址D，得出目的网络地址为N
2. 若N与此路由器直接相连，则把数据报直接交付目的主机D，否则
3. 若路由表中有目的地址为D的特定主机路由，则把数据报发送到下一跳路由，否则
4. 若路由表中有到达网络N的路由，则发送到下一跳，否则
5. 若有默认路由，则发送到默认路由，否则
6. 报告转发分组出错

使用掩码的分组转发过程

1. 从分组首部提取目的IP地址D
2. 用路由器所连各网络的掩码与D按位与，看与网络地址是否匹配，匹配则直接交付，否则
3. 若路由表中有目的地址为D的特定主机路由，则发送相应下一跳，否则
4. 对路由表中每一行的子网掩码和D逐位与，匹配相应网络地址，传送下一跳，否则
5. 若有默认路由，传送默认路由，否则
6. 出错

（6）IPv6协议

地址空间：16字节128位，删除了分段域和校验和域

报头格式：基本首部40字节+扩展

<img src="/Users/wangzifan/Desktop/通信网络/pic/IPv6报头格式.png" alt="IPv6报头格式" style="zoom:50%;" />

IPv6扩展报头

<img src="/Users/wangzifan/Desktop/通信网络/pic/IPv6扩展报头.png" alt="IPv6扩展报头" style="zoom:50%;" />

IPv6地址类型

- 单播Unicast，发送到单播地址的数据包被传输到这个地址识别出的单一接口
  - 全球单播地址，全球路由前缀+子网ID+主机ID
  - 链路本地地址，FE80::/10，后64位为接口标识符，在本地链路所连节点中使用
  - 回环地址::1
  - 未指定地址::
  - 唯一本地IPv6单播地址
  - 内嵌IPv4地址
- 任播Anycast，发送到任播地址的数据包被传输到这个地址识别出的**最近接口**
- 组播Multicast，发送到组播地址的数据包被传输到这个地址识别出的**所有接口**
  - FF00::/8

##### 7.2 ICMP、ARP、RARP协议

##### ARP

IP地址--ARP--物理地址，物理地址--RARP--IP地址

ARP是解决**同一个局域网内**的主机或路由器的IP地址和硬件地址的映射问题：

- 直接交付时，ARP解析的是目的主机IP地址与MAC地址的映射——ARP广播帧
- 间接交付时，ARP解析的是下一跳路由器IP地址与MAC地址的映射

ARP高速缓存：减少地址解析的次数，缓存中每个映射项设有生存时间。

##### ICMP

功能：主机/路由器报告差错情况和异常情况，查询主机是否可达、报文传递时间。

ICMP报文种类：

- ICMP差错报告报文：终点不可达/源点抑制/时间超过/参数问题/改变路由（重定向）

<img src="/Users/wangzifan/Desktop/通信网络/pic/ICMP差错报告报文.png" alt="ICMP差错报告报文" style="zoom:50%;" />

- ICMP询问报文：回送请求和回答报文（测试目的主机是否可达），时间戳请求和回答报文（进行时钟同步和测量时间）

> 不发送ICMP差错报告报文的情况：
>
> - 对ICMP差错报告报文不再发送
> - 对分片的数据报，除第一个分片外，后续分片不发送
> - 对具有多播地址的数据报不发送
> - 对特殊地址的数据报不发送

Traceroute：通过TTL递增的一系列ICMP数据报超时报文得到途径路由器

##### 7.3 VPN和NAT

##### 7.4 路由选择协议

因特网的两大类路由选择协议

- 内部网关协议IGP(Interior Gateway Protocol)：在AS（自治系统）内部使用的路由选择协议，如RIP，OSPF
- 外部网关协议EGP(Exterior Gateway Protocol)：在AS的边界使用的协议，如BGP-4

（1）路由信息协议RIP（Routing Information Protocol）

原理：基于**距离向量**，要求每一个路由器都要维护自己到AS内部其它网络的距离和下一跳路由器地址。

距离由跳数定义，直连的网络跳数为1，每多经过一个路由器再+1，距离最大值为16，RIP只适用于小型网络。

RIP要点：

- 仅和相邻路由器交换信息
- 交换的信息是本路由器所知道的全部信息，即自己的路由表（到AS内其它网络的距离及下一跳路由器）
- 按固定时间间隔交换信息

（2）开放最短路径优先OSPF（Open Shortest Path First）

要点：

- 向本AS中所有路由器发送信息——泛洪法
- 信息包括本路由相邻的所有路由器的链路状态
- 只当链路状态变化时才泛洪发送此信息



---

### 7 传输层

#### 7.1 传输层的功能

传输层——为用户提供端到端的通信

- 介于通信子网和资源子网之间，对高层用户屏蔽了通信的细节
- 弥补了通信子网所提供服务的差异和不足，提供端到端之间的无差错保证
- 传输层工作的简繁取决于通信子网提供服务的类型

传输层为高层用户提供了传送层实体间的**端到端的、可靠的、全双工的**通信。

#### 7.2传输层的服务

传输层依据应用层要求提供服务

- 会话层提出传输条件方面的要求，用传输连接建立服务原语中的**服务质量QoS**参数传递
- 传输层需要事先知道网络连接的服务质量，根据不同质量定义相匹配的传输服务和协议等级。
- 通信子网提供的服务越多，传输协议越简单；反之越复杂

网络层提供的服务类型：

- A型网络服务：完善，分组丢失率、重复、篡改率可忽略，仅需简单的传输层协议
- B型
- C型：相当不可靠

OSI传输层的协议类型

| 传输协议类别 | 网络服务类型 | 基本功能             |
| ------------ | ------------ | -------------------- |
| TP~0~        | A            | 建立连接             |
| TP~1~        | B            | 基本差错修复         |
| TP~2~        | A            | 复用                 |
| TP~3~        | B            | 差错修复与复用       |
| TP~$~        | C            | 差错检测与修复，复用 |

> TP~0~～TP~4~复杂性递增，0～3只适用于面向连接，数据发送前需建立会话连接，4既可以面向连接也可以无连接。

#### 7.3 传输层协议的要素

（1）寻址

传输服务访问点TSAP：两个程序建立连接时，需要指明对方，这个标记称为**传输层地址，即TSAP**。

> 在TCP协议中传输层地址即TCP的端口号。
>
> 网络层地址——网络服务访问点NSAP在IP协议中即IP地址。

在计算机内部进程用**进程标识符**来标志，进行网络通信的进程用**协议端口号/端口**标识。

端口的作用：

- 屏蔽不同操作系统间进程标识符格式的不同
- 端口实际上与应用功能相对应

端口用一个16位端口号（65536个）表示，只具有**本地意义**，通信的两个进程需要知道对方的IP地址和端口号。

- **熟知端口号/系统端口号**：0～1024

<img src="/Users/wangzifan/Desktop/通信网络/pic/常用的熟知端口号.png" alt="常用的熟知端口号" style="zoom:50%;" />

- **登记端口号**：1024～49151
- **客户端口号**：49152～65535，供客户进程暂时使用

获取对方TSAP的方法：

- 熟知的TSAP
- 采用名字服务器/目录服务器，用户向服务器发送服务的名称，服务器返回对应的TSAP
- 服务器将分配的TSAP通知主机

初始连接协议Initial Connection Protocol

- 当服务程序很多时，使用ICP
- 一个称为**进程服务器**的进程同时在多个端口上监听
- 客户向TSAP发出连接请求，若没有相应的服务程序在此端口监听，则客户和进程服务器建立连接
- 进程服务器产生所请求的服务进程，使进程继承当前连接
- 进程服务器返回继续监听，客户与服务程序通信

（2）连接管理

连接的作用：

- 通信子网的不可靠性
- 通信子网中延时和分组丢失、重复分组
- 超时的分组
- 保证连接的唯一性

##### 建立连接

三次握手

<img src="/Users/wangzifan/Desktop/通信网络/pic/三次握手.png" alt="三次握手" style="zoom:50%;" />

1. 主机1发送连接请求，序号为x
2. 主机2应答请求，并声明自己的序号y
3. 主机1收到后发送数据，并确认主机2的序号ack=y

异常的连接建立：

- 主机2收到主机1的过期连接请求，并向其响应，主机1拒绝。
- 主机2收到主机1的过期连接请求，响应后，又收到过期的确认，但响应和过期确认的序列号不同，因此连接无法建立。

##### 连接释放

非对称释放——一方中止连接，连接即告中断，可能导致数据丢失。

对称释放：A提出中止请求，B同意，则终止。

三次握手

<img src="/Users/wangzifan/Desktop/通信网络/pic/三次握手释放连接.png" alt="三次握手释放连接" style="zoom:50%;" />

1. 主机1在数据传输结束后，发送Disconnect Request，启动计时器
2. 主机2收到DR后，同意释放连接，也发送DR，启动计时器
3. 主机1在未超时前收到DR，便释放连接，并发送ACK
4. 主机2在未超时前收到ACK，释放连接

异常释放：

- 最后的ACK丢失，主机2由于计时器超时，释放连接
- 主机2收到DR同意释放，但向主机1发送的DR丢失，主机1由于超时，重发DR，重新三次握手
- 双方的DR重复丢失，n此重发后释放连接

（3）流量控制和缓冲策略

（4）多路复用

（5）崩溃的恢复

#### 7.4 因特网的传输层协议

（1）用户数据报协议User Data Protocol

UDP功能：

- UDP只在IP的服务上增加了**端口**和**差错检测**功能
- UDP只能提供不可靠的交付，传输的可靠性由应用程序解决
- UDP协议开销小、效率高

UDP特点：

- 无连接
- 最大努力交付，即不保证可靠交付
- 面向报文
- 没有拥塞控制
- 首部开销小，只有8字节

UDP将上层报文原封不动作为数据，添加首部交付IP层，应用程序需要选择合适大小的报文

<img src="/Users/wangzifan/Desktop/通信网络/pic/UDP协议的报文处理.png" alt="UDP协议的报文处理" style="zoom:50%;" />

UDP首部格式

| 2字节  | 2字节    | 2字节 | 2字节  |
| ------ | -------- | ----- | ------ |
| 源端口 | 目的端口 | 长度  | 校验和 |

（2）传输控制协议Transmission Control Protocol

TCP功能：

- TCP**面向连接**
- 每一条TCP连接只能有两个端点
- TCP提供**可靠交付**的服务
- TCP提供**全双工**通信
- TCP面向**字节流**

TCP连接的端点叫做套接字socket（IP地址：端口号），一个套接字允许被多个连接同时使用。

TCP首部格式

<img src="/Users/wangzifan/Desktop/通信网络/pic/TCP首部格式.png" alt="TCP首部格式" style="zoom:50%;" />

| 字段        | 含义                                                         |
| ----------- | ------------------------------------------------------------ |
| 序号        | TCP数据流每一个字节都编上一个序号，序号字段值为本报文端数据部分第一个字节的序号 |
| 确认号      | 期望收到的对方下一个报文段数据的第一个字节的序号             |
| 数据偏移    | 即首部长度，数据起始处离报文段起始处有多远（以**4字节**为单位） |
| URG         | 紧急，置1表明紧急指针字段有效，报文中有紧急数据，高优先级    |
| ACK         | =1确认号字段有效，=0确认号无效                               |
| PSH         | 推送，PSH=1的报文应尽快交付应用进程，不再等到缓存填满        |
| RST         | 复位，=1表明差错，需要重连                                   |
| SYN         | 同步，=1表明此报文为连接请求/连接接收报文                    |
| FIN         | 终止，=1表明释放连接                                         |
| 窗口        | 自己的接收窗口大小                                           |
| 校验和      | 校验首部和数据，计算时要在TCP报文端首加上12字节的伪首部      |
| 紧急指针    | 指出紧急数据的长度（字节），紧急数据放在数据部分的最前面     |
| MSS（选项） | Maximum Segment Size，最大数据长度                           |

TCP的可靠传输

- 窗口机制

- 超时重传

  TCP每发送一个报文端，就设置一次超时计时器，超时未确认则重传（与往返时间RTT相关）

- 选择确认SACK

TCP的拥塞控制

开环——预防，闭环——解决

拥塞控制算法（闭环）

- 端系统上使用的源算法：慢开始、拥塞避免、乘法减小、快重传和快恢复
- 网络设备上使用的链路算法：早期随机检测RED

发送方维持一个状态变量**拥塞窗口**，发送窗口=min{拥塞窗口cwnd，接收窗口rwnd}

慢开始算法：cwnd初值=1（即一个MSS的数值），每收到一个对新的报文段段确认，cwnd+1（+MSS）

<img src="/Users/wangzifan/Desktop/通信网络/pic/TCP拥塞控制-慢开始算法.png" alt="TCP拥塞控制-慢开始算法" style="zoom:50%;" />

慢开始门限状态变量ssthresh

- cwnd<ssthresh，使用慢开始算法
- cwnd>ssthresh，停止慢开始，改用拥塞避免算法

拥塞避免算法

- 加法增大：每过一个RTT，cwnd+1
- 乘法减小：发送方判断网络出现拥塞，ssthresh设置为出现时cwnd的1/2，并将cwnd重置为1，执行慢开始
- 快重传：接收方收到失序报文立即发出重复确认，接收方一连收到三个重复确认就应当立即重传丢失的报文段

<img src="/Users/wangzifan/Desktop/通信网络/pic/快重传.png" alt="快重传" style="zoom:50%;" />

- 快恢复：发送端收到连续三个重复确认时，设置ssthresh为当前cwnd的1/2，设置cwnd为ssthresh，加法增大（此时可能并没有发生拥塞，因此cwnd不置1，不执行慢开始）

<img src="/Users/wangzifan/Desktop/通信网络/pic/快恢复.png" alt="快恢复" style="zoom:50%;" />

运输连接：包括三个阶段——连接建立/数据传输/连接释放。运输连接的管理就是使连接的建立和释放正常进行。

三次握手

<img src="/Users/wangzifan/Desktop/通信网络/pic/TCP连接建立及两端状态.png" alt="TCP连接建立及两端状态" style="zoom:50%;" />

四次挥手

<img src="/Users/wangzifan/Desktop/通信网络/pic/TCP释放连接及两端状态.png" alt="TCP释放连接及两端状态" style="zoom:50%;" />

> A必须等待2MSL时间，保证A的最后ACK能送到，并使本次连接内产生的报文从网络中消失，以防其出现在下一个新的连接中。

保活计时器：服务器每次收到客户端数据就重置保活计时器，若超时未收到客户数据，发送探测报文，一连10个探测报文无响应则关闭连接。



---

### 八 应用层

#### 8.1 应用层概述

应用层提供应用进程与通信进程间的接口，基于**客户/服务器**方式。

#### 8.2 DHCP

动态主机配置协议，Dynamic Host Configuration Protocol，提供即插即用联网机制，允许计算机加入新的网络自动获取IP地址。

DHCP工作方式C/S：

- 主机向DHCP服务器**广播**发送**发现报文**
- 本地网络所有主机都收到报文，但只有DHCP服务器回答报文
- DHCP在数据库中查找该计算机的配置信息，找到则返回，找不到则从IP池中分配一个

每一个网络至少有一个DHCP中继代理relay agent，接收主机发送的发现报文，**单播**转发给DHCP服务器，并将其回答报文返回给主机。

> DHCP报文基于UDP。

租用期：DHCP服务器分配的IP有时间限制，即租用期。

工作步骤：

1. S被动打开UDP端口67
2. C从UDP端口68发送DHCPDISCOVER
3. 凡收到DHCPDISCOVER的S都可以回复DHCPOFFER
4. C选择一个，广播请求报文DHCPREQUEST
5. S发送DHCPACK，C可以使用IP地址
6. C根据租用期T，设置T~1~=0.5T，T~2~=0.875T，超过T~1~，C发送DHCPREQUEST更新租用期
7. S同意则DHCPACK，不同意则DHCPNACK，此时C需要停用并重新申请
8. 若S不响应，当超过T~2~，C重发DHCPREQUEST
9. C可随时终止租用，发送DHCPRELEASE

#### 8.3 DNS

因特网采用层次结构的命名树作为主机的名字

DNS（Domain Name System）提供域名与IP地址间的映射关系，将域名解析为IP地址

因特网的**层次树状结构**域名：....三级域名.二级域名.顶级域名

域名服务器的管辖范围以区为单位

<img src="/Users/wangzifan/Desktop/通信网络/pic/域名服务器的管辖范围.png" alt="域名服务器的管辖范围" style="zoom:50%;" />

域名服务器的类型：

- 根域名服务器：知道所有的顶级域名服务器的域名和IP地址，使用迭代查询，把应当查找的顶级域名服务器的IP告诉本地域名服务器
- 顶级域名服务器（TLD服务器）：管理在该顶级域名服务器注册的所有二级域名，迭代查询
- 权限域名服务器：负责一个**区**的域名解析，不能给出查询回答时，告诉客户下一步需要查找的权限域名服务器
- 本地域名服务器（默认域名服务器）

> DNS域名服务器把数据复制到多个服务器，一个是主DNS，其他是辅助DNS

解析过程：

- 主机向本地DNS——递归查询，由DNS代替主机查询
- 本地DNS向根DNS——迭代查询，根DNS给出IP或下一步查询的DNS的IP

<img src="/Users/wangzifan/Desktop/通信网络/pic/DNS递归和迭代查询.png" alt="DNS递归和迭代查询" style="zoom:50%;" />

#### 8.4 E-mail

发送邮件的协议：SMTP，读取邮件的协议POP3和IMAP

电子邮件传递步骤：

1. 发件人调用电脑中的代理UA
2. UA通过SMTP协议发送邮件到发送方邮件服务器
3. SMTP服务器将邮件存入缓存队列
4. 发送方服务器的SMTP客户与接收方服务器的SMTP服务器建立TCP连接，发送队列中邮件
5. 接收方服务器将邮件放入用户邮箱，等待收件人读取
6. 收件人收信时允许电脑UA，使用POP3/IMAP协议读取邮件

邮局协议POP（Post Office Protocol）：收件人运行POP客户程序，邮件服务器运行POP服务器程序

IMAP（Internet Message Access Protocol）：用户运行IMAP客户程序，服务器运行IMAP服务器程序

基于万维网的email：发件人--HTTP--邮件服务器--SMTP--邮件服务器--HTTP--收件人

> SMTP缺点：
>
> - 限传送7位ASCII
> - 拒绝超长邮件

MIME多功能因特网邮件扩充服务（Multipurpose Internet Mail Extensions），增加了邮件主体结构，定义了传送非ASCII的编码规则

<img src="/Users/wangzifan/Desktop/通信网络/pic/MIME与SMTP.png" alt="MIME与SMTP" style="zoom:50%;" />

#### 8.5 WWW

统一资源定位符URL（Uniform Resource Locator），每个文档在整个因特网内具有唯一的标识符。

HTTP：

- 面向事务，C/S
- HTTP本身是无连接的，使用面向连接的TCP提供的服务
- HTTP是无状态的

浏览器处理超链接：

1. 浏览器分析URL
2. 浏览器向DNS请求域名对应的IP地址
3. 浏览器与服务器建立TCP链接
4. get /index.html
5. 服务器响应
6. TCP连接释放
7. 浏览器显示html

HTTP1:保活连接keep alive，服务器响应后在一段时间内保持连接，可以继续响应客户请求

HTTP2:HTTP复用TCP

HTTP3:QUIC，Quick UDP Internet Connection

HTTP请求报文的结构

<img src="/Users/wangzifan/Desktop/通信网络/pic/HTTP请求报文.png" alt="HTTP请求报文" style="zoom:50%;" />

HTTP响应报文

<img src="/Users/wangzifan/Desktop/通信网络/pic/HTTP响应报文.png" alt="HTTP响应报文" style="zoom:50%;" />

| 状态码 | 含义                      |
| ------ | ------------------------- |
| 1xx    | 通知信息（收到/正在处理） |
| 2xx    | 成功                      |
| 3xx    | 重定向                    |
| 4xx    | 客户出错                  |
| 5xx    | 服务器出错                |

#### 8.6 FTP

文件传输协议FTP（File Transfer Protocol），C/S

FTP服务器：

- 主进程：被动打开21端口，等待连接请求，启动从属进程处理请求
- 从属进程：传送数据

> 主进程和从属进程并发

客户端与服务器建立两个TCP连接：控制连接，数据连接，客户端的请求通过控制连接发给服务器21端口，并告知自己的数据连接端口号，服务器的控制进程创建数据传送进程，通过20端口在数据连接上传送数据。

FTP服务器的运行模式：

- 主动方式PORT：客户向服务器21端口控制连接发送PORT命令，服务器从20端口与客户指定端口连接传送数据（可能被客户防火墙阻塞）
- 被动方式PASV：客户向21发送PASV命令，服务器随机打开一个高端端口，通过PORT通知客户，客户连接此端口，服务器传送数据（可能被服务器防火墙阻塞）

#### 8.7 TELNET

传送用户的击键和服务器的输出（网络虚拟终端NVT格式），透明，使得用户感觉直接使用主机

TELNET服务器：主进程等待连接，从属进程处理连接

#### 8.8 SNMP

工作方式：C/S，管理程序运行SNMP客户程序，代理程序运行SNMP服务器程序，网管系统中往往是少数客户与很多服务器交互（SNMP报文，基于UDP）

SNMP包括管理信息结构SMI和管理信息库MIB

SMI（Structure of Management Information）
